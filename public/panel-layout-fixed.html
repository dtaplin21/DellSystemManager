<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoQC - Panel Layout Tool</title>
  <style>
    :root {
      --color-navy-50: #f0f4f8;
      --color-navy-100: #d9e2ec;
      --color-navy-200: #bcccdc;
      --color-navy-300: #9fb3c8;
      --color-navy-400: #829ab1;
      --color-navy-500: #627d98;
      --color-navy-600: #486581;
      --color-navy-700: #334e68;
      --color-navy-800: #243b53;
      --color-navy-900: #102a43;
      --color-navy-950: #0a2463;
      
      --color-orange-50: #fff8f1;
      --color-orange-100: #feecdc;
      --color-orange-200: #fcd9bd;
      --color-orange-300: #fdba8c;
      --color-orange-400: #ff8a4c;
      --color-orange-500: #ff7f11;
      --color-orange-600: #d03801;
      --color-orange-700: #b43403;
      --color-orange-800: #8a2c0d;
      --color-orange-900: #73230d;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--color-navy-50);
      color: var(--color-navy-800);
      line-height: 1.5;
    }
    
    header {
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--color-navy-950);
    }
    
    nav {
      display: flex;
      gap: 1.5rem;
    }
    
    nav a {
      text-decoration: none;
      color: var(--color-navy-600);
      transition: color 0.2s;
    }
    
    nav a:hover {
      color: var(--color-orange-500);
    }
    
    .active {
      color: var(--color-navy-950);
      font-weight: 500;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .panel-layout-interface {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 2rem;
      min-height: calc(100vh - 200px);
    }
    
    .panel-controls {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 800px;
      overflow-y: auto;
    }
    
    .control-section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--color-navy-100);
      padding-bottom: 1.5rem;
    }
    
    .control-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-navy-800);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: var(--color-navy-700);
    }
    
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .dimensions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .btn {
      display: inline-block;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 0.875rem;
      text-align: center;
    }
    
    .btn-primary {
      background: var(--color-navy-950);
      color: white;
    }
    
    .btn-primary:hover {
      background: #041640;
    }
    
    .btn-secondary {
      background: white;
      color: var(--color-navy-950);
      border: 1px solid var(--color-navy-300);
    }
    
    .btn-secondary:hover {
      background: var(--color-navy-50);
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    .btn-group {
      display: flex;
      gap: 0.5rem;
    }
    
    .panel-viewer-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .viewer-toolbar {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--color-navy-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .toolbar-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-navy-800);
    }
    
    .panel-viewer {
      flex-grow: 1;
      background-color: #f8fafc;
      background-image: 
        linear-gradient(to right, #e2e8f0 1px, transparent 1px),
        linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
      background-size: 20px 20px;
      border: 1px dashed var(--color-navy-300);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
      min-height: 400px;
    }

    .panel-item {
      position: absolute;
      background: rgba(10, 36, 99, 0.15);
      border: 2px solid var(--color-navy-950);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      transition: all 0.2s;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-navy-950);
      overflow: hidden;
      box-sizing: border-box;
      padding: 2px;
    }

    .panel-item .panel-label {
      text-align: center;
      width: 100%;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .panel-label .roll-text,
    .panel-label .panel-text {
      width: 100%;
      text-align: center;
      line-height: 1;
      white-space: nowrap;
    }

    .panel-label .roll-text {
      font-size: 0.8em;
      font-weight: 500;
    }

    .panel-label .panel-text {
      font-size: 1em;
      font-weight: 600;
    }

    .panel-item.triangle {
      clip-path: polygon(0% 0%, 100% 0%, 0% 100%);
      background: rgba(10, 36, 99, 0.15);
      border: 2px solid var(--color-navy-950);
      border-radius: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: all 0.2s;
    }

    .panel-item:hover {
      background: rgba(255, 127, 17, 0.15);
      border-color: var(--color-orange-500);
      transform: scale(1.02);
    }

    .panel-item.selected {
      background: rgba(255, 127, 17, 0.25);
      border-color: var(--color-orange-500);
      box-shadow: 0 0 0 2px rgba(255, 127, 17, 0.3);
    }

    .resize-handle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--color-orange-500);
      border: 1px solid white;
      border-radius: 2px;
      cursor: pointer;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .panel-item.selected .resize-handle {
      opacity: 1;
    }

    .resize-handle.nw-resize { cursor: nw-resize; top: -4px; left: -4px; }
    .resize-handle.ne-resize { cursor: ne-resize; top: -4px; right: -4px; }
    .resize-handle.sw-resize { cursor: sw-resize; bottom: -4px; left: -4px; }
    .resize-handle.se-resize { cursor: se-resize; bottom: -4px; right: -4px; }
    .resize-handle.w-resize { cursor: w-resize; top: 50%; left: -4px; transform: translateY(-50%); }
    .resize-handle.e-resize { cursor: e-resize; top: 50%; right: -4px; transform: translateY(-50%); }
    
    /* Rotation handle */
    .rotate-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--color-navy-950);
      right: -6px;
      top: -6px;
      border-radius: 50%;
      cursor: grab;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .panel-item.selected .rotate-handle {
      opacity: 1;
    }

    /* Real-time dimension display */
    .panel-dimensions {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 4px;
      font-size: 0.6em;
      line-height: 1;
      border-radius: 3px;
      pointer-events: none;
      color: var(--color-navy-950);
      font-weight: 600;
      border: 1px solid rgba(10, 36, 99, 0.2);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Shape toggle styles */
    .shape-toggle {
      display: flex;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .shape-option {
      flex: 1;
      padding: 0.5rem;
      text-align: center;
      background: white;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .shape-option.selected {
      background: var(--color-navy-950);
      color: white;
    }
    
    .panel-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      margin-bottom: 1rem;
      padding: 0.5rem;
    }
    
    .panel-list-item {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--color-navy-100);
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
    }
    
    .panel-list-item:last-child {
      border-bottom: none;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 350px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 1rem;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .toast-title {
      font-weight: 600;
    }

    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
      color: var(--color-navy-500);
    }

    .toast-message {
      color: var(--color-navy-600);
    }

    /* Modal styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-content h2 {
      margin-top: 0;
      color: var(--color-navy-950);
      margin-bottom: 1.5rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
      border: none;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">GeoQC</div>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/dashboard/projects">Projects</a>
      <a href="/panel-layout-fixed" class="active">Panel Layout</a>
      <a href="/dashboard/qc-data">QC Data</a>
      <a href="/dashboard/documents">Documents</a>
    </nav>
  </header>
  
  <div class="container">
    <div class="panel-layout-interface">
      <div class="panel-controls">
        <div class="control-section">
          <h2 class="section-title">Panel Management</h2>
          <div class="form-group">
            <label>Panel Shape</label>
            <div class="shape-toggle">
              <div class="shape-option selected" data-shape="rectangle">Rectangle</div>
              <div class="shape-option" data-shape="triangle">Triangle</div>
              <div class="shape-option" data-shape="hexagon">Hexagon</div>
            </div>
          </div>
          
          <!-- Panel Identification -->
          <div class="form-group">
            <label for="panel-roll">Roll Number</label>
            <input type="text" id="panel-roll" placeholder="e.g. R-102" required>
          </div>

          <div class="form-group">
            <label for="panel-number">Panel Number</label>
            <input type="text" id="panel-number" placeholder="e.g. P-001" required>
          </div>

          <div id="rectangle-controls" class="shape-controls">
            <div class="form-group">
              <label>Add Rectangular Panel</label>
              <div class="dimensions-grid">
                <div>
                  <label for="panel-width">Width (ft)</label>
                  <input type="number" id="panel-width" value="15" min="1" max="100">
                </div>
                <div>
                  <label for="panel-length">Length (ft)</label>
                  <input type="number" id="panel-length" value="100" min="1" max="500">
                </div>
              </div>
            </div>
          </div>
          
          <div id="triangle-controls" class="shape-controls" style="display: none;">
            <div class="form-group">
              <label>Add Triangle Panel</label>
              <div class="input-row">
                <div class="input-wrapper">
                  <label for="triangle-base">Base (ft)</label>
                  <input type="number" id="triangle-base" value="15" min="1" max="100">
                </div>
                <div class="input-wrapper">
                  <label for="triangle-height">Height (ft)</label>
                  <input type="number" id="triangle-height" value="12" min="1" max="100">
                </div>
              </div>
              <button id="add-triangle" type="button" class="btn btn-primary">Add Triangle</button>
              <small>Enter base and height for triangle panel</small>
            </div>
          </div>

          <div id="hexagon-controls" class="shape-controls" style="display: none;">
            <div class="form-group">
              <label>Add Hexagon Panel</label>
              <div class="input-row">
                <div class="input-wrapper">
                  <label for="hexagon-size">Side Length (ft)</label>
                  <input type="number" id="hexagon-size" value="10" min="1" max="50">
                </div>
              </div>
              <button id="add-hexagon" type="button" class="btn btn-primary">Add Hexagon</button>
              <small>Enter the side length for a regular hexagon panel</small>
            </div>
          </div>


          
          <div class="form-group">
            <label for="panel-material">Material Type</label>
            <select id="panel-material">
              <option>HDPE 60 mil</option>
              <option>HDPE 80 mil</option>
              <option>LLDPE 40 mil</option>
              <option>PVC 30 mil</option>
              <option>GCL</option>
            </select>
          </div>
          <div class="form-group">
            <button id="add-panel" class="btn btn-primary btn-block">Add Panel</button>
          </div>
          
          <div class="panel-list" id="panel-list">
            <!-- Panels will be listed here dynamically -->
          </div>
          
          <div class="btn-group">
            <button id="optimize-layout" class="btn btn-primary">Optimize Layout</button>
            <button id="export-layout" class="btn btn-secondary">Export</button>
            <button id="clear-panels" class="btn btn-secondary">Clear All</button>
          </div>
        </div>
      </div>
      
      <div class="panel-viewer-container">
        <div class="viewer-toolbar">
          <h2 class="toolbar-title">Panel Layout Viewer</h2>
        </div>
        
        <div class="panel-viewer" id="panel-viewer">
          <!-- Panel layout will be displayed here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast notification -->
  <div class="toast" id="toast">
    <div class="toast-header">
      <div class="toast-title">Notification</div>
      <button class="toast-close">&times;</button>
    </div>
    <div class="toast-message">This is a notification</div>
  </div>

  <!-- Edit Panel Modal -->
  <div id="edit-panel-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Edit Panel</h2>
      <input type="hidden" id="edit-panel-id">

      <div class="form-group">
        <label for="edit-panel-roll">Roll Number</label>
        <input type="text" id="edit-panel-roll">
      </div>

      <div class="form-group">
        <label for="edit-panel-number">Panel Number</label>
        <input type="text" id="edit-panel-number">
      </div>

      <div class="modal-actions">
        <button id="save-panel-btn" class="btn btn-primary">Save</button>
        <button id="delete-panel-btn" class="btn btn-danger">Delete</button>
        <button id="cancel-edit-btn" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables and functions
    let panels = [];
    let selectedPanel = null;
    let panelCounter = 1;
    let selectedShape = 'rectangle';

    // Edit Panel Modal Functions (must be global)
    function openEditModal(panelId) {
      const panel = panels.find(p => p.id === panelId);
      if (!panel) return;

      const editModal = document.getElementById('edit-panel-modal');
      const rollInput = document.getElementById('edit-panel-roll');
      const numberInput = document.getElementById('edit-panel-number');
      const idInput = document.getElementById('edit-panel-id');

      idInput.value = panel.id;
      rollInput.value = panel.rollNumber;
      numberInput.value = panel.panelNumber;
      editModal.style.display = 'block';
    }

    function closeEditModal() {
      document.getElementById('edit-panel-modal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const panelWidthInput = document.getElementById('panel-width');
      const panelLengthInput = document.getElementById('panel-length');
      const panelMaterialSelect = document.getElementById('panel-material');
      const addPanelBtn = document.getElementById('add-panel');
      const panelList = document.getElementById('panel-list');
      const clearPanelsBtn = document.getElementById('clear-panels');
      const shapeOptions = document.querySelectorAll('.shape-option');
      const rectangleControls = document.getElementById('rectangle-controls');
      const polygonControls = document.getElementById('polygon-controls');
      const panelViewer = document.getElementById('panel-viewer');
      const toast = document.getElementById('toast');
      const toastClose = document.querySelector('.toast-close');

      // Set up edit modal event listeners
      document.getElementById('save-panel-btn').addEventListener('click', function() {
        const id = document.getElementById('edit-panel-id').value;
        const roll = document.getElementById('edit-panel-roll').value.trim();
        const number = document.getElementById('edit-panel-number').value.trim();
        const panelEl = document.getElementById(id);
        const panelObj = panels.find(p => p.id === id);

        if (roll && number && panelEl && panelObj) {
          panelObj.rollNumber = roll;
          panelObj.panelNumber = number;
          panelObj.id = number;
          panelEl.id = number;
          const label = panelEl.querySelector('.panel-label');
          label.textContent = `${roll} • ${number}`;
          updatePanelList();
          showToast('Panel Updated', 'Panel updated successfully!');
        }
        closeEditModal();
      });

      document.getElementById('delete-panel-btn').addEventListener('click', function() {
        const id = document.getElementById('edit-panel-id').value;
        const panelEl = document.getElementById(id);
        if (panelEl) panelEl.remove();
        panels = panels.filter(p => p.id !== id);
        updatePanelList();
        showToast('Panel Deleted', 'Panel removed successfully.');
        closeEditModal();
      });

      document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);

      // Snap-to-neighbors functionality
      function snapPosition(panelEl, proposedX, proposedY, threshold = 5) {
        const w = panelEl.offsetWidth;
        const h = panelEl.offsetHeight;

        // current edges of the moving panel
        let edges = {
          left:   proposedX,
          right:  proposedX + w,
          top:    proposedY,
          bottom: proposedY + h
        };

        document.querySelectorAll('.panel-item').forEach(otherEl => {
          if (otherEl === panelEl) return;       // skip itself

          const ox = otherEl.offsetLeft;
          const oy = otherEl.offsetTop;
          const ow = otherEl.offsetWidth;
          const oh = otherEl.offsetHeight;

          // edges of the stationary panel
          const other = {
            left:   ox,
            right:  ox + ow,
            top:    oy,
            bottom: oy + oh
          };

          // Horizontal snapping
          if (Math.abs(edges.left  - other.right) <= threshold) {
            proposedX = other.right;
            edges.left  = proposedX;
            edges.right = proposedX + w;
          } else if (Math.abs(edges.right - other.left) <= threshold) {
            proposedX = other.left - w;
            edges.left  = proposedX;
            edges.right = proposedX + w;
          }

          // Vertical snapping
          if (Math.abs(edges.top    - other.bottom) <= threshold) {
            proposedY = other.bottom;
            edges.top    = proposedY;
            edges.bottom = proposedY + h;
          } else if (Math.abs(edges.bottom - other.top) <= threshold) {
            proposedY = other.top - h;
            edges.top    = proposedY;
            edges.bottom = proposedY + h;
          }
        });

        return { x: proposedX, y: proposedY };
      }

      // Rotation functionality
      function addRotateLogic(handle, panelEl, panelData) {
        let rotating = false;
        let startAngle = 0;
        let initialRot = panelData.rotation || 0;
        let center = { x:0, y:0 };

        handle.addEventListener('mousedown', e => {
          e.stopPropagation();
          rotating = true;
          // compute center of element
          const rect = panelEl.getBoundingClientRect();
          center = {
            x: rect.left + rect.width/2,
            y: rect.top  + rect.height/2
          };
          startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x);
          initialRot = panelData.rotation || 0;
          document.body.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', e => {
          if (!rotating) return;
          const current = Math.atan2(e.clientY - center.y, e.clientX - center.x);
          const delta  = current - startAngle;
          const deg    = initialRot + delta * (180/Math.PI);
          panelData.rotation = deg;
          panelEl.style.transform = `rotate(${deg}deg)`;
        });

        document.addEventListener('mouseup', e => {
          if (!rotating) return;
          rotating = false;
          document.body.style.cursor = '';
        });
      }
      
      // Initialize shape selection
      shapeOptions.forEach(function(option) {
        option.addEventListener('click', function() {
          shapeOptions.forEach(function(opt) { 
            opt.classList.remove('selected'); 
          });
          this.classList.add('selected');
          selectedShape = this.dataset.shape;
          
          // Show/hide appropriate controls
          document.querySelectorAll('.shape-controls').forEach(function(control) {
            control.style.display = 'none';
          });
          
          if (selectedShape === 'rectangle') {
            document.getElementById('rectangle-controls').style.display = 'block';
          } else if (selectedShape === 'triangle') {
            document.getElementById('triangle-controls').style.display = 'block';
          } else if (selectedShape === 'hexagon') {
            document.getElementById('hexagon-controls').style.display = 'block';
          } else if (selectedShape === 'polygon') {
            document.getElementById('polygon-controls').style.display = 'block';
          }
        });
      });
      
      // Add new panel
      addPanelBtn.addEventListener('click', function() {
        const roll = document.getElementById('panel-roll').value.trim();
        const number = document.getElementById('panel-number').value.trim();

        if (!roll || !number) {
          showToast('Missing Data', 'Please enter both roll number and panel number.');
          return;
        }

        if (selectedShape === 'rectangle') {
          // Add rectangular panel
          const width = parseFloat(panelWidthInput.value);
          const length = parseFloat(panelLengthInput.value);
          const material = panelMaterialSelect.value;
          
          // Validate inputs
          if (isNaN(width) || isNaN(length) || width <= 0 || length <= 0) {
            showToast('Invalid Input', 'Please enter valid width and length values.');
            return;
          }
          
          const panel = {
            id: number,
            rollNumber: roll,
            panelNumber: number,
            width: width,
            length: length,
            material: material,
            shape: 'rectangle',
            x: 50 + (panels.length * 20),
            y: 50 + (panels.length * 15)
          };
          
          panels.push(panel);
          updatePanelList();
          createVisualPanel(panel);
          showToast('Panel Added', `Roll ${roll}, Panel ${number} added successfully.`);
          
          // Clear the roll and panel number fields for next entry
          document.getElementById('panel-roll').value = '';
          document.getElementById('panel-number').value = '';
          
        } else if (selectedShape === 'polygon') {
          // For polygon, guide user to create using click interface
          showToast('Create Polygon', 'Click on the viewer area to start creating polygon points. Right-click when finished.');
        }
      });
      
      // Add triangle panel
      document.getElementById('add-triangle').addEventListener('click', function() {
        const roll = document.getElementById('panel-roll').value.trim();
        const number = document.getElementById('panel-number').value.trim();

        if (!roll || !number) {
          showToast('Missing Data', 'Please enter both roll number and panel number.');
          return;
        }

        const base = parseFloat(document.getElementById('triangle-base').value);
        const height = parseFloat(document.getElementById('triangle-height').value);
        
        if (isNaN(base) || isNaN(height) || base <= 0 || height <= 0) {
          showToast('Invalid Input', 'Please enter valid base and height values for the triangle.');
          return;
        }
        
        const panel = {
          id: number,
          rollNumber: roll,
          panelNumber: number,
          base: base,
          height: height,
          shape: 'triangle',
          material: document.getElementById('panel-material').value,
          x: 50 + (panels.length * 20),
          y: 50 + (panels.length * 15),
          width: base,
          length: height
        };
        
        panels.push(panel);
        updatePanelList();
        createVisualPanel(panel);
        showToast('Panel Added', `Roll ${roll}, Panel ${number} added successfully.`);
        
        // Clear the roll and panel number fields for next entry
        document.getElementById('panel-roll').value = '';
        document.getElementById('panel-number').value = '';
      });
      
      // Add hexagon panel
      document.getElementById('add-hexagon').addEventListener('click', function() {
        const roll = document.getElementById('panel-roll').value.trim();
        const number = document.getElementById('panel-number').value.trim();

        if (!roll || !number) {
          showToast('Missing Data', 'Please enter both roll number and panel number.');
          return;
        }

        const sideLength = parseFloat(document.getElementById('hexagon-size').value);
        
        if (isNaN(sideLength) || sideLength <= 0) {
          showToast('Invalid Input', 'Please enter a valid side length for the hexagon.');
          return;
        }
        
        const panel = {
          id: number,
          rollNumber: roll,
          panelNumber: number,
          sideLength: sideLength,
          shape: 'hexagon',
          material: document.getElementById('panel-material').value,
          x: 50 + (panels.length * 20),
          y: 50 + (panels.length * 15),
          width: sideLength * 2,
          length: sideLength * Math.sqrt(3)
        };
        
        panels.push(panel);
        updatePanelList();
        createVisualPanel(panel);
        showToast('Panel Added', `Roll ${roll}, Panel ${number} added successfully.`);
        
        // Clear the roll and panel number fields for next entry
        document.getElementById('panel-roll').value = '';
        document.getElementById('panel-number').value = '';
      });
      
      // Optimize layout using Python backend
      document.getElementById('optimize-layout').addEventListener('click', function() {
        if (panels.length === 0) {
          showToast('No Panels', 'Please add some panels before optimizing.');
          return;
        }
        
        optimizeLayout();
      });
      
      // Export layout functionality
      document.getElementById('export-layout').addEventListener('click', function() {
        if (panels.length === 0) {
          showToast('No Panels', 'Please add some panels before exporting.');
          return;
        }
        
        exportLayout();
      });
      
      // Optimize layout function
      async function optimizeLayout() {
        try {
          showToast('Optimizing...', 'Running AI optimization on your panel layout.');
          
          const siteConfig = {
            width: 500, // Default site dimensions - could be made configurable
            length: 300,
            noGoZones: []
          };
          
          const optimizationData = {
            siteConfig: siteConfig,
            panels: panels.map(panel => ({
              id: panel.id,
              width: panel.width,
              length: panel.length,
              shape: panel.shape,
              material: panel.material,
              x: panel.x,
              y: panel.y,
              rotation: panel.rotation || 0
            })),
            strategy: 'balanced'
          };
          
          const response = await fetch('/api/panel-layout/optimize', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(optimizationData)
          });
          
          if (!response.ok) {
            throw new Error('Optimization failed');
          }
          
          const result = await response.json();
          
          // Update panels with optimized positions
          if (result.panels) {
            result.panels.forEach(optimizedPanel => {
              const existingPanel = panels.find(p => p.id === optimizedPanel.id);
              if (existingPanel) {
                existingPanel.x = optimizedPanel.x;
                existingPanel.y = optimizedPanel.y;
                existingPanel.rotation = optimizedPanel.rotation || 0;
              }
            });
            
            // Refresh visual display
            clearVisualPanels();
            panels.forEach(panel => createVisualPanel(panel));
            updatePanelList();
            
            showToast('Optimization Complete', `Layout optimized successfully! Coverage: ${result.summary?.coverage || 'N/A'}`);
          }
          
        } catch (error) {
          console.error('Optimization error:', error);
          showToast('Optimization Failed', 'Could not connect to optimization service. Please check that the Python backend is running.');
        }
      }
      
      // Export layout function
      async function exportLayout() {
        try {
          const exportData = {
            format: 'excel', // Could be made configurable (dxf, excel)
            panels: panels,
            summary: {
              totalPanels: panels.length,
              totalArea: panels.reduce((sum, panel) => sum + (panel.width * panel.length), 0)
            }
          };
          
          const response = await fetch('http://localhost:8001/export', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(exportData)
          });
          
          if (!response.ok) {
            throw new Error('Export failed');
          }
          
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `panel-layout-${Date.now()}.xlsx`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          showToast('Export Complete', 'Panel layout exported successfully!');
          
        } catch (error) {
          console.error('Export error:', error);
          showToast('Export Failed', 'Could not export layout. Please check that the Python backend is running.');
        }
      }
      
      // Create visual panel on grid
      function createVisualPanel(panel) {
        const panelElement = document.createElement('div');
        panelElement.className = 'panel-item';
        panelElement.id = panel.id;
        
        // Clear any existing children
        panelElement.innerHTML = '';
        
        // Create and append the centered label
        const label = document.createElement('div');
        label.className = 'panel-label';
        label.innerHTML = `
          <div class="roll-text">${panel.rollNumber}</div>
          <div class="panel-text">${panel.panelNumber}</div>
        `;
        panelElement.appendChild(label);

        // Add dimension badge showing real-time size
        const dimLabel = document.createElement('span');
        dimLabel.className = 'panel-dimensions';
        dimLabel.textContent = `${panel.width.toFixed(1)}ft × ${panel.length.toFixed(1)}ft`;
        panelElement.appendChild(dimLabel);
        panelElement._dimLabel = dimLabel;
        
        // Add shape-specific class
        if (panel.shape === 'triangle') {
          panelElement.classList.add('triangle');
        }
        
        // Scale dimensions for display (1 foot = 2 pixels)
        const displayWidth = panel.width * 2;
        const displayHeight = panel.length * 2;
        
        panelElement.style.left = panel.x + 'px';
        panelElement.style.top = panel.y + 'px';
        panelElement.style.width = displayWidth + 'px';
        panelElement.style.height = displayHeight + 'px';
        
        // Dynamically scale font size based on panel dimensions
        const baseSize = Math.min(displayWidth, displayHeight);
        const fontSize = Math.max(8, Math.floor(baseSize * 0.3)) + 'px';
        label.querySelectorAll('div').forEach(el => {
          el.style.fontSize = fontSize;
        });
        
        // Ensure transforms happen around center
        panelElement.style.transformOrigin = 'center center';
        
        // Apply existing rotation if any
        if (panel.rotation) {
          panelElement.style.transform = `rotate(${panel.rotation}deg)`;
        }
        
        // Add resize handles
        addResizeHandles(panelElement, panel);
        
        // Add rotate handle
        const rotateHandle = document.createElement('div');
        rotateHandle.className = 'rotate-handle';
        panelElement.appendChild(rotateHandle);
        
        // Wire up rotation logic
        addRotateLogic(rotateHandle, panelElement, panel);
        
        // Add click handler to open edit modal
        panelElement.addEventListener('click', function(e) {
          e.stopPropagation();
          openEditModal(panel.id);
        });
        
        // Add drag functionality
        makePanelDraggable(panelElement, panel);
        
        panelViewer.appendChild(panelElement);
      }
      
      // Make panel draggable
      function makePanelDraggable(element, panel) {
        let isDragging = false;
        let startX, startY;
        
        element.addEventListener('mousedown', function(e) {
          isDragging = true;
          startX = e.clientX - panel.x;
          startY = e.clientY - panel.y;
          element.style.zIndex = '1000';
        });
        
        document.addEventListener('mousemove', function(e) {
          if (isDragging) {
            const newX = e.clientX - startX;
            const newY = e.clientY - startY;
            
            // Apply snapping to nearby panels
            const snapped = snapPosition(element, newX, newY, 10);
            
            panel.x = snapped.x;
            panel.y = snapped.y;
            element.style.left = snapped.x + 'px';
            element.style.top = snapped.y + 'px';
          }
        });
        
        document.addEventListener('mouseup', function() {
          if (isDragging) {
            isDragging = false;
            element.style.zIndex = '';
          }
        });
      }
      
      // Add resize handles to panel
      function addResizeHandles(panelElement, panel) {
        const handles = ['nw-resize', 'ne-resize', 'sw-resize', 'se-resize', 'w-resize', 'e-resize'];
        
        handles.forEach(function(handleType) {
          const handle = document.createElement('div');
          handle.className = 'resize-handle ' + handleType;
          handle.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            startResize(e, panel, handleType);
          });
          panelElement.appendChild(handle);
        });
      }
      
      // Start resize operation
      function startResize(e, panel, resizeType) {
        e.preventDefault();
        
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = panel.width;
        const startHeight = panel.length;
        const startPosX = panel.x;
        const startPosY = panel.y;
        
        function onMouseMove(e) {
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          
          let newWidth = startWidth;
          let newHeight = startHeight;
          let newX = startPosX;
          let newY = startPosY;
          
          // Calculate new dimensions based on resize handle type
          if (resizeType.includes('e')) {
            newWidth = Math.max(5, startWidth + (deltaX / 2)); // Minimum 5 feet
          }
          if (resizeType.includes('w')) {
            newWidth = Math.max(5, startWidth - (deltaX / 2));
            newX = startPosX + (startWidth - newWidth) * 2;
          }
          if (resizeType.includes('s')) {
            newHeight = Math.max(5, startHeight + (deltaY / 2));
          }
          if (resizeType.includes('n')) {
            newHeight = Math.max(5, startHeight - (deltaY / 2));
            newY = startPosY + (startHeight - newHeight) * 2;
          }
          
          // Update panel object
          panel.width = newWidth;
          panel.length = newHeight;
          panel.x = newX;
          panel.y = newY;
          
          // Update the dimension badge with real-time measurements
          const panelEl = document.getElementById(panel.id);
          const dimBadge = panelEl._dimLabel;
          if (dimBadge) {
            dimBadge.textContent = `${newWidth.toFixed(1)}ft × ${newHeight.toFixed(1)}ft`;
            // Scale the badge text based on panel size
            const baseSize = Math.min(newWidth * 2, newHeight * 2);
            dimBadge.style.fontSize = Math.max(8, Math.floor(baseSize * 0.08)) + 'px';
          }
          
          // Update visual element
          updatePanelVisual(panel);
          updatePanelList();
        }
        
        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      }
      
      // Snap position helper for edge alignment
      function snapPosition(panelEl, proposedX, proposedY, threshold = 0.2) {
        const w = panelEl.offsetWidth;
        const h = panelEl.offsetHeight;

        // Current edges of the moving panel
        let edges = {
          left: proposedX,
          right: proposedX + w,
          top: proposedY,
          bottom: proposedY + h
        };

        document.querySelectorAll('.panel-item').forEach(function(otherEl) {
          if (otherEl === panelEl) return; // Skip itself

          const ox = otherEl.offsetLeft;
          const oy = otherEl.offsetTop;
          const ow = otherEl.offsetWidth;
          const oh = otherEl.offsetHeight;

          // Edges of the stationary panel
          const other = {
            left: ox,
            right: ox + ow,
            top: oy,
            bottom: oy + oh
          };

          // Horizontal snapping
          if (Math.abs(edges.left - other.right) <= threshold) {
            proposedX = other.right;
            edges.left = proposedX;
            edges.right = proposedX + w;
          } else if (Math.abs(edges.right - other.left) <= threshold) {
            proposedX = other.left - w;
            edges.left = proposedX;
            edges.right = proposedX + w;
          }

          // Vertical snapping
          if (Math.abs(edges.top - other.bottom) <= threshold) {
            proposedY = other.bottom;
            edges.top = proposedY;
            edges.bottom = proposedY + h;
          } else if (Math.abs(edges.bottom - other.top) <= threshold) {
            proposedY = other.top - h;
            edges.top = proposedY;
            edges.bottom = proposedY + h;
          }
        });

        return { x: proposedX, y: proposedY };
      }

      // Add rotation logic
      function addRotateLogic(handle, panelEl, panelData) {
        let rotating = false;
        let startAngle = 0;
        let initialRot = panelData.rotation || 0;
        let center = { x: 0, y: 0 };

        handle.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          rotating = true;
          // Compute center of element
          const rect = panelEl.getBoundingClientRect();
          center = {
            x: rect.left + rect.width / 2,
            y: rect.top + rect.height / 2
          };
          startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x);
          initialRot = panelData.rotation || 0;
          document.body.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', function(e) {
          if (!rotating) return;
          const current = Math.atan2(e.clientY - center.y, e.clientX - center.x);
          const delta = current - startAngle;
          const deg = initialRot + delta * (180 / Math.PI);
          panelData.rotation = deg;
          panelEl.style.transform = `rotate(${deg}deg)`;
        });

        document.addEventListener('mouseup', function(e) {
          if (!rotating) return;
          rotating = false;
          document.body.style.cursor = '';
          updatePanelList();
        });
      }

      // Update panel visual appearance
      function updatePanelVisual(panel) {
        const panelElement = document.getElementById(panel.id);
        if (panelElement) {
          const displayWidth = panel.width * 2;
          const displayHeight = panel.length * 2;
          
          panelElement.style.left = panel.x + 'px';
          panelElement.style.top = panel.y + 'px';
          panelElement.style.width = displayWidth + 'px';
          panelElement.style.height = displayHeight + 'px';
          
          // Apply rotation if it exists
          if (panel.rotation) {
            panelElement.style.transform = `rotate(${panel.rotation}deg)`;
          }
        }
      }
      
      // Select panel
      function selectPanel(panelId) {
        // Remove selection from all panels
        document.querySelectorAll('.panel-item').forEach(function(el) {
          el.classList.remove('selected');
        });
        
        // Add selection to clicked panel
        const panelElement = document.getElementById(panelId);
        if (panelElement) {
          panelElement.classList.add('selected');
          selectedPanel = panelId;
        }
      }
      
      // Update panel list
      function updatePanelList() {
        panelList.innerHTML = '';
        panels.forEach(function(panel) {
          const listItem = document.createElement('div');
          listItem.className = 'panel-list-item';
          listItem.innerHTML = 
            '<span>' + panel.id + ' (' + panel.shape + ')</span>' +
            '<span>' + panel.material + '</span>';
          panelList.appendChild(listItem);
        });
      }
      
      // Clear all panels
      clearPanelsBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all panels?')) {
          panels = [];
          panelList.innerHTML = '';
          
          // Remove all visual panels from grid
          document.querySelectorAll('.panel-item').forEach(function(panel) {
            panel.remove();
          });
          
          selectedPanel = null;
          showToast('Info', 'All panels cleared');
        }
      });
      
      // Helper function to show toast notification
      function showToast(title, message) {
        const toastTitle = document.querySelector('.toast-title');
        const toastMessage = document.querySelector('.toast-message');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        toast.classList.add('show');
        
        setTimeout(function() {
          toast.classList.remove('show');
        }, 3000);
      }
      
      // Toast close button
      toastClose.addEventListener('click', function() {
        toast.classList.remove('show');
      });
    });
  </script>
</body>
</html>