<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoQC - Panel Layout Tool</title>
  <style>
    :root {
      --color-navy-50: #f0f4f8;
      --color-navy-100: #d9e2ec;
      --color-navy-200: #bcccdc;
      --color-navy-300: #9fb3c8;
      --color-navy-400: #829ab1;
      --color-navy-500: #627d98;
      --color-navy-600: #486581;
      --color-navy-700: #334e68;
      --color-navy-800: #243b53;
      --color-navy-900: #102a43;
      --color-navy-950: #0a2463;
      
      --color-orange-50: #fff8f1;
      --color-orange-100: #feecdc;
      --color-orange-200: #fcd9bd;
      --color-orange-300: #fdba8c;
      --color-orange-400: #ff8a4c;
      --color-orange-500: #ff7f11;
      --color-orange-600: #d03801;
      --color-orange-700: #b43403;
      --color-orange-800: #8a2c0d;
      --color-orange-900: #73230d;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--color-navy-50);
      color: var(--color-navy-800);
      line-height: 1.5;
    }
    
    header {
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--color-navy-950);
    }
    
    nav {
      display: flex;
      gap: 1.5rem;
    }
    
    nav a {
      text-decoration: none;
      color: var(--color-navy-600);
      transition: color 0.2s;
    }
    
    nav a:hover {
      color: var(--color-orange-500);
    }
    
    .active {
      color: var(--color-navy-950);
      font-weight: 500;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .panel-layout-interface {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 2rem;
      min-height: calc(100vh - 200px);
    }
    
    .panel-controls {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 800px;
      overflow-y: auto;
    }
    
    .control-section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--color-navy-100);
      padding-bottom: 1.5rem;
    }
    
    .control-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-navy-800);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: var(--color-navy-700);
    }
    
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .dimensions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .btn {
      display: inline-block;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 0.875rem;
      text-align: center;
    }
    
    .btn-primary {
      background: var(--color-navy-950);
      color: white;
    }
    
    .btn-primary:hover {
      background: #041640;
    }
    
    .btn-secondary {
      background: white;
      color: var(--color-navy-950);
      border: 1px solid var(--color-navy-300);
    }
    
    .btn-secondary:hover {
      background: var(--color-navy-50);
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    .btn-group {
      display: flex;
      gap: 0.5rem;
    }
    
    .panel-viewer-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .viewer-toolbar {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--color-navy-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .toolbar-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-navy-800);
    }
    
    .panel-viewer {
      flex-grow: 1;
      background-color: #f8fafc;
      background-image: 
        linear-gradient(to right, #e2e8f0 1px, transparent 1px),
        linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
      background-size: 20px 20px;
      border: 1px dashed var(--color-navy-300);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
      min-height: 400px;
    }

    .panel-item {
      position: absolute;
      background: rgba(10, 36, 99, 0.15);
      border: 2px solid var(--color-navy-950);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: move;
      transition: all 0.2s;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-navy-950);
    }

    .panel-item.triangle {
      background: rgba(10, 36, 99, 0.15);
      border: 2px solid var(--color-navy-950);
      border-radius: 0;
      clip-path: polygon(0% 0%, 100% 0%, 0% 100%);
    }

    .panel-item:hover {
      background: rgba(255, 127, 17, 0.15);
      border-color: var(--color-orange-500);
      transform: scale(1.02);
    }

    .panel-item.selected {
      background: rgba(255, 127, 17, 0.25);
      border-color: var(--color-orange-500);
      box-shadow: 0 0 0 2px rgba(255, 127, 17, 0.3);
    }

    .resize-handle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--color-orange-500);
      border: 1px solid white;
      border-radius: 2px;
      cursor: pointer;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .panel-item.selected .resize-handle {
      opacity: 1;
    }

    .resize-handle.nw-resize { cursor: nw-resize; top: -4px; left: -4px; }
    .resize-handle.ne-resize { cursor: ne-resize; top: -4px; right: -4px; }
    .resize-handle.sw-resize { cursor: sw-resize; bottom: -4px; left: -4px; }
    .resize-handle.se-resize { cursor: se-resize; bottom: -4px; right: -4px; }
    .resize-handle.w-resize { cursor: w-resize; top: 50%; left: -4px; transform: translateY(-50%); }
    .resize-handle.e-resize { cursor: e-resize; top: 50%; right: -4px; transform: translateY(-50%); }
    
    /* Rotation handle */
    .rotate-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--color-navy-950);
      right: -6px;
      top: -6px;
      border-radius: 50%;
      cursor: grab;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .panel-item.selected .rotate-handle {
      opacity: 1;
    }
    
    /* Shape toggle styles */
    .shape-toggle {
      display: flex;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .shape-option {
      flex: 1;
      padding: 0.5rem;
      text-align: center;
      background: white;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .shape-option.selected {
      background: var(--color-navy-950);
      color: white;
    }
    
    .panel-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      margin-bottom: 1rem;
      padding: 0.5rem;
    }
    
    .panel-list-item {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--color-navy-100);
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
    }
    
    .panel-list-item:last-child {
      border-bottom: none;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 350px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 1rem;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .toast-title {
      font-weight: 600;
    }

    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      line-height: 1;
      color: var(--color-navy-500);
    }

    .toast-message {
      color: var(--color-navy-600);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">GeoQC</div>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/dashboard/projects">Projects</a>
      <a href="/panel-layout-fixed" class="active">Panel Layout</a>
      <a href="/dashboard/qc-data">QC Data</a>
      <a href="/dashboard/documents">Documents</a>
    </nav>
  </header>
  
  <div class="container">
    <div class="panel-layout-interface">
      <div class="panel-controls">
        <div class="control-section">
          <h2 class="section-title">Panel Management</h2>
          <div class="form-group">
            <label>Panel Shape</label>
            <div class="shape-toggle">
              <div class="shape-option selected" data-shape="rectangle">Rectangle</div>
              <div class="shape-option" data-shape="triangle">Triangle</div>
              <div class="shape-option" data-shape="hexagon">Hexagon</div>
              <div class="shape-option" data-shape="polygon">Custom Polygon</div>
            </div>
          </div>
          
          <div id="rectangle-controls" class="shape-controls">
            <div class="form-group">
              <label>Add Rectangular Panel</label>
              <div class="dimensions-grid">
                <div>
                  <label for="panel-width">Width (ft)</label>
                  <input type="number" id="panel-width" value="15" min="1" max="100">
                </div>
                <div>
                  <label for="panel-length">Length (ft)</label>
                  <input type="number" id="panel-length" value="100" min="1" max="500">
                </div>
              </div>
            </div>
          </div>
          
          <div id="triangle-controls" class="shape-controls" style="display: none;">
            <div class="form-group">
              <label>Add Triangle Panel</label>
              <div class="input-row">
                <div class="input-wrapper">
                  <label for="triangle-base">Base (ft)</label>
                  <input type="number" id="triangle-base" value="15" min="1" max="100">
                </div>
                <div class="input-wrapper">
                  <label for="triangle-height">Height (ft)</label>
                  <input type="number" id="triangle-height" value="12" min="1" max="100">
                </div>
              </div>
              <button id="add-triangle" type="button" class="btn btn-primary">Add Triangle</button>
              <small>Enter base and height for triangle panel</small>
            </div>
          </div>

          <div id="hexagon-controls" class="shape-controls" style="display: none;">
            <div class="form-group">
              <label>Add Hexagon Panel</label>
              <div class="input-row">
                <div class="input-wrapper">
                  <label for="hexagon-size">Side Length (ft)</label>
                  <input type="number" id="hexagon-size" value="10" min="1" max="50">
                </div>
              </div>
              <button id="add-hexagon" type="button" class="btn btn-primary">Add Hexagon</button>
              <small>Enter the side length for a regular hexagon panel</small>
            </div>
          </div>

          <div id="polygon-controls" class="shape-controls" style="display: none;">
            <div class="form-group">
              <label>Create Custom Polygon</label>
              <p style="font-size: 0.75rem; color: var(--color-navy-600); margin-bottom: 0.5rem;">
                Click on the viewer to add polygon points. Right-click to finish.
              </p>
            </div>
          </div>
          
          <div class="form-group">
            <label for="panel-material">Material Type</label>
            <select id="panel-material">
              <option>HDPE 60 mil</option>
              <option>HDPE 80 mil</option>
              <option>LLDPE 40 mil</option>
              <option>PVC 30 mil</option>
              <option>GCL</option>
            </select>
          </div>
          <div class="form-group">
            <button id="add-panel" class="btn btn-primary btn-block">Add Panel</button>
          </div>
          
          <div class="panel-list" id="panel-list">
            <!-- Panels will be listed here dynamically -->
          </div>
          
          <div class="btn-group">
            <button id="clear-panels" class="btn btn-secondary">Clear All</button>
          </div>
        </div>
      </div>
      
      <div class="panel-viewer-container">
        <div class="viewer-toolbar">
          <h2 class="toolbar-title">Panel Layout Viewer</h2>
        </div>
        
        <div class="panel-viewer" id="panel-viewer">
          <!-- Panel layout will be displayed here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast notification -->
  <div class="toast" id="toast">
    <div class="toast-header">
      <div class="toast-title">Notification</div>
      <button class="toast-close">&times;</button>
    </div>
    <div class="toast-message">This is a notification</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const panelWidthInput = document.getElementById('panel-width');
      const panelLengthInput = document.getElementById('panel-length');
      const panelMaterialSelect = document.getElementById('panel-material');
      const addPanelBtn = document.getElementById('add-panel');
      const panelList = document.getElementById('panel-list');
      const clearPanelsBtn = document.getElementById('clear-panels');
      const shapeOptions = document.querySelectorAll('.shape-option');
      const rectangleControls = document.getElementById('rectangle-controls');
      const polygonControls = document.getElementById('polygon-controls');
      const panelViewer = document.getElementById('panel-viewer');
      const toast = document.getElementById('toast');
      const toastClose = document.querySelector('.toast-close');
      
      // Variables
      let panelCounter = 1;
      let panels = [];
      let selectedShape = 'rectangle';
      let selectedPanel = null;
      
      // Initialize shape selection
      shapeOptions.forEach(function(option) {
        option.addEventListener('click', function() {
          shapeOptions.forEach(function(opt) { 
            opt.classList.remove('selected'); 
          });
          this.classList.add('selected');
          selectedShape = this.dataset.shape;
          
          // Show/hide appropriate controls
          document.querySelectorAll('.shape-controls').forEach(function(control) {
            control.style.display = 'none';
          });
          
          if (selectedShape === 'rectangle') {
            document.getElementById('rectangle-controls').style.display = 'block';
          } else if (selectedShape === 'triangle') {
            document.getElementById('triangle-controls').style.display = 'block';
          } else if (selectedShape === 'hexagon') {
            document.getElementById('hexagon-controls').style.display = 'block';
          } else if (selectedShape === 'polygon') {
            document.getElementById('polygon-controls').style.display = 'block';
          }
        });
      });
      
      // Add new panel
      addPanelBtn.addEventListener('click', function() {
        if (selectedShape === 'rectangle') {
          // Add rectangular panel
          const width = parseFloat(panelWidthInput.value);
          const length = parseFloat(panelLengthInput.value);
          const material = panelMaterialSelect.value;
          
          // Validate inputs
          if (isNaN(width) || isNaN(length) || width <= 0 || length <= 0) {
            showToast('Invalid Input', 'Please enter valid width and length values.');
            return;
          }
          
          const panel = {
            id: 'panel-' + panelCounter++,
            width: width,
            length: length,
            material: material,
            shape: 'rectangle',
            x: 50 + (panels.length * 20), // Offset each new panel
            y: 50 + (panels.length * 15)
          };
          
          panels.push(panel);
          updatePanelList();
          createVisualPanel(panel);
          showToast('Panel Added', 'Rectangular panel ' + panel.id + ' added successfully.');
          
        } else if (selectedShape === 'polygon') {
          // For polygon, guide user to create using click interface
          showToast('Create Polygon', 'Click on the viewer area to start creating polygon points. Right-click when finished.');
        }
      });
      
      // Add triangle panel
      document.getElementById('add-triangle').addEventListener('click', function() {
        const base = parseFloat(document.getElementById('triangle-base').value);
        const height = parseFloat(document.getElementById('triangle-height').value);
        
        if (isNaN(base) || isNaN(height) || base <= 0 || height <= 0) {
          showToast('Invalid Input', 'Please enter valid base and height values for the triangle.');
          return;
        }
        
        const panel = {
          id: 'panel-' + panelCounter++,
          base: base,
          height: height,
          shape: 'triangle',
          material: document.getElementById('panel-material').value,
          x: 50 + (panels.length * 20),
          y: 50 + (panels.length * 15),
          // Use base and height as width/length for bounding box
          width: base,
          length: height
        };
        
        panels.push(panel);
        updatePanelList();
        createVisualPanel(panel);
        showToast('Panel Added', 'Triangle panel ' + panel.id + ' added successfully.');
      });
      
      // Add hexagon panel
      document.getElementById('add-hexagon').addEventListener('click', function() {
        const sideLength = parseFloat(document.getElementById('hexagon-size').value);
        
        if (isNaN(sideLength) || sideLength <= 0) {
          showToast('Invalid Input', 'Please enter a valid side length for the hexagon.');
          return;
        }
        
        const panel = {
          id: 'panel-' + panelCounter++,
          sideLength: sideLength,
          shape: 'hexagon',
          material: document.getElementById('panel-material').value,
          x: 50 + (panels.length * 20),
          y: 50 + (panels.length * 15),
          // Calculate approximate width/height for hexagon
          width: sideLength * 2,
          length: sideLength * Math.sqrt(3)
        };
        
        panels.push(panel);
        updatePanelList();
        createVisualPanel(panel);
        showToast('Panel Added', 'Hexagon panel ' + panel.id + ' added successfully.');
      });
      
      // Create visual panel on grid
      function createVisualPanel(panel) {
        const panelElement = document.createElement('div');
        panelElement.className = 'panel-item';
        panelElement.id = panel.id;
        panelElement.textContent = panel.id;
        
        // Add shape-specific class
        if (panel.shape === 'triangle') {
          panelElement.classList.add('triangle');
        }
        
        // Scale dimensions for display (1 foot = 2 pixels)
        const displayWidth = panel.width * 2;
        const displayHeight = panel.length * 2;
        
        panelElement.style.left = panel.x + 'px';
        panelElement.style.top = panel.y + 'px';
        panelElement.style.width = displayWidth + 'px';
        panelElement.style.height = displayHeight + 'px';
        
        // Ensure transforms happen around center
        panelElement.style.transformOrigin = 'center center';
        
        // Apply existing rotation if any
        if (panel.rotation) {
          panelElement.style.transform = `rotate(${panel.rotation}deg)`;
        }
        
        // Add resize handles
        addResizeHandles(panelElement, panel);
        
        // Add rotate handle
        const rotateHandle = document.createElement('div');
        rotateHandle.className = 'rotate-handle';
        panelElement.appendChild(rotateHandle);
        
        // Wire up rotation logic
        addRotateLogic(rotateHandle, panelElement, panel);
        
        // Add click handler for selection
        panelElement.addEventListener('click', function(e) {
          e.stopPropagation();
          selectPanel(panel.id);
        });
        
        // Add drag functionality
        makePanelDraggable(panelElement, panel);
        
        panelViewer.appendChild(panelElement);
      }
      
      // Make panel draggable
      function makePanelDraggable(element, panel) {
        let isDragging = false;
        let startX, startY;
        
        element.addEventListener('mousedown', function(e) {
          isDragging = true;
          startX = e.clientX - panel.x;
          startY = e.clientY - panel.y;
          element.style.zIndex = '1000';
        });
        
        document.addEventListener('mousemove', function(e) {
          if (isDragging) {
            const newX = e.clientX - startX;
            const newY = e.clientY - startY;
            
            // Apply snapping to nearby panels
            const snapped = snapPosition(element, newX, newY, 10);
            
            panel.x = snapped.x;
            panel.y = snapped.y;
            element.style.left = snapped.x + 'px';
            element.style.top = snapped.y + 'px';
          }
        });
        
        document.addEventListener('mouseup', function() {
          if (isDragging) {
            isDragging = false;
            element.style.zIndex = '';
          }
        });
      }
      
      // Add resize handles to panel
      function addResizeHandles(panelElement, panel) {
        const handles = ['nw-resize', 'ne-resize', 'sw-resize', 'se-resize', 'w-resize', 'e-resize'];
        
        handles.forEach(function(handleType) {
          const handle = document.createElement('div');
          handle.className = 'resize-handle ' + handleType;
          handle.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            startResize(e, panel, handleType);
          });
          panelElement.appendChild(handle);
        });
      }
      
      // Start resize operation
      function startResize(e, panel, resizeType) {
        e.preventDefault();
        
        const startX = e.clientX;
        const startY = e.clientY;
        const startWidth = panel.width;
        const startHeight = panel.length;
        const startPosX = panel.x;
        const startPosY = panel.y;
        
        function onMouseMove(e) {
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          
          let newWidth = startWidth;
          let newHeight = startHeight;
          let newX = startPosX;
          let newY = startPosY;
          
          // Calculate new dimensions based on resize handle type
          if (resizeType.includes('e')) {
            newWidth = Math.max(5, startWidth + (deltaX / 2)); // Minimum 5 feet
          }
          if (resizeType.includes('w')) {
            newWidth = Math.max(5, startWidth - (deltaX / 2));
            newX = startPosX + (startWidth - newWidth) * 2;
          }
          if (resizeType.includes('s')) {
            newHeight = Math.max(5, startHeight + (deltaY / 2));
          }
          if (resizeType.includes('n')) {
            newHeight = Math.max(5, startHeight - (deltaY / 2));
            newY = startPosY + (startHeight - newHeight) * 2;
          }
          
          // Update panel object
          panel.width = newWidth;
          panel.length = newHeight;
          panel.x = newX;
          panel.y = newY;
          
          // Update visual element
          updatePanelVisual(panel);
          updatePanelList();
        }
        
        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      }
      
      // Snap position helper for edge alignment
      function snapPosition(panelEl, proposedX, proposedY, threshold = 0.2) {
        const w = panelEl.offsetWidth;
        const h = panelEl.offsetHeight;

        // Current edges of the moving panel
        let edges = {
          left: proposedX,
          right: proposedX + w,
          top: proposedY,
          bottom: proposedY + h
        };

        document.querySelectorAll('.panel-item').forEach(function(otherEl) {
          if (otherEl === panelEl) return; // Skip itself

          const ox = otherEl.offsetLeft;
          const oy = otherEl.offsetTop;
          const ow = otherEl.offsetWidth;
          const oh = otherEl.offsetHeight;

          // Edges of the stationary panel
          const other = {
            left: ox,
            right: ox + ow,
            top: oy,
            bottom: oy + oh
          };

          // Horizontal snapping
          if (Math.abs(edges.left - other.right) <= threshold) {
            proposedX = other.right;
            edges.left = proposedX;
            edges.right = proposedX + w;
          } else if (Math.abs(edges.right - other.left) <= threshold) {
            proposedX = other.left - w;
            edges.left = proposedX;
            edges.right = proposedX + w;
          }

          // Vertical snapping
          if (Math.abs(edges.top - other.bottom) <= threshold) {
            proposedY = other.bottom;
            edges.top = proposedY;
            edges.bottom = proposedY + h;
          } else if (Math.abs(edges.bottom - other.top) <= threshold) {
            proposedY = other.top - h;
            edges.top = proposedY;
            edges.bottom = proposedY + h;
          }
        });

        return { x: proposedX, y: proposedY };
      }

      // Add rotation logic
      function addRotateLogic(handle, panelEl, panelData) {
        let rotating = false;
        let startAngle = 0;
        let initialRot = panelData.rotation || 0;
        let center = { x: 0, y: 0 };

        handle.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          rotating = true;
          // Compute center of element
          const rect = panelEl.getBoundingClientRect();
          center = {
            x: rect.left + rect.width / 2,
            y: rect.top + rect.height / 2
          };
          startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x);
          initialRot = panelData.rotation || 0;
          document.body.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', function(e) {
          if (!rotating) return;
          const current = Math.atan2(e.clientY - center.y, e.clientX - center.x);
          const delta = current - startAngle;
          const deg = initialRot + delta * (180 / Math.PI);
          panelData.rotation = deg;
          panelEl.style.transform = `rotate(${deg}deg)`;
        });

        document.addEventListener('mouseup', function(e) {
          if (!rotating) return;
          rotating = false;
          document.body.style.cursor = '';
          updatePanelList();
        });
      }

      // Update panel visual appearance
      function updatePanelVisual(panel) {
        const panelElement = document.getElementById(panel.id);
        if (panelElement) {
          const displayWidth = panel.width * 2;
          const displayHeight = panel.length * 2;
          
          panelElement.style.left = panel.x + 'px';
          panelElement.style.top = panel.y + 'px';
          panelElement.style.width = displayWidth + 'px';
          panelElement.style.height = displayHeight + 'px';
          
          // Apply rotation if it exists
          if (panel.rotation) {
            panelElement.style.transform = `rotate(${panel.rotation}deg)`;
          }
        }
      }
      
      // Select panel
      function selectPanel(panelId) {
        // Remove selection from all panels
        document.querySelectorAll('.panel-item').forEach(function(el) {
          el.classList.remove('selected');
        });
        
        // Add selection to clicked panel
        const panelElement = document.getElementById(panelId);
        if (panelElement) {
          panelElement.classList.add('selected');
          selectedPanel = panelId;
        }
      }
      
      // Update panel list
      function updatePanelList() {
        panelList.innerHTML = '';
        panels.forEach(function(panel) {
          const listItem = document.createElement('div');
          listItem.className = 'panel-list-item';
          listItem.innerHTML = 
            '<span>' + panel.id + ' (' + panel.shape + ')</span>' +
            '<span>' + panel.material + '</span>';
          panelList.appendChild(listItem);
        });
      }
      
      // Clear all panels
      clearPanelsBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all panels?')) {
          panels = [];
          panelList.innerHTML = '';
          
          // Remove all visual panels from grid
          document.querySelectorAll('.panel-item').forEach(function(panel) {
            panel.remove();
          });
          
          selectedPanel = null;
          showToast('Info', 'All panels cleared');
        }
      });
      
      // Helper function to show toast notification
      function showToast(title, message) {
        const toastTitle = document.querySelector('.toast-title');
        const toastMessage = document.querySelector('.toast-message');
        
        toastTitle.textContent = title;
        toastMessage.textContent = message;
        
        toast.classList.add('show');
        
        setTimeout(function() {
          toast.classList.remove('show');
        }, 3000);
      }
      
      // Toast close button
      toastClose.addEventListener('click', function() {
        toast.classList.remove('show');
      });
    });
  </script>
</body>
</html>