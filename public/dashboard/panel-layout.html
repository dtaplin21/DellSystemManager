<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoQC - Professional Panel Layout Tool</title>
  <style>
    :root {
      --color-navy-50: #f0f4f8;
      --color-navy-100: #d9e2ec;
      --color-navy-200: #bcccdc;
      --color-navy-300: #9fb3c8;
      --color-navy-400: #829ab1;
      --color-navy-500: #627d98;
      --color-navy-600: #486581;
      --color-navy-700: #334e68;
      --color-navy-800: #243b53;
      --color-navy-900: #102a43;
      --color-navy-950: #0a2463;
      
      --color-orange-50: #fff8f1;
      --color-orange-100: #feecdc;
      --color-orange-200: #fcd9bd;
      --color-orange-300: #fdba8c;
      --color-orange-400: #ff8a4c;
      --color-orange-500: #ff7f11;
      --color-orange-600: #d03801;
      --color-orange-700: #b43403;
      --color-orange-800: #8a2c0d;
      --color-orange-900: #73230d;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--color-navy-50);
      color: var(--color-navy-800);
      line-height: 1.5;
    }
    
    header {
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--color-navy-950);
    }
    
    nav {
      display: flex;
      gap: 1.5rem;
    }
    
    nav a {
      text-decoration: none;
      color: var(--color-navy-600);
      transition: color 0.2s;
    }
    
    nav a:hover {
      color: var(--color-orange-500);
    }
    
    .active {
      color: var(--color-navy-950);
      font-weight: 500;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .panel-layout-interface {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 2rem;
      min-height: calc(100vh - 200px);
    }
    
    .panel-controls {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .control-section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--color-navy-100);
      padding-bottom: 1.5rem;
    }
    
    .control-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-navy-800);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: var(--color-navy-700);
    }
    
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .dimensions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .btn {
      display: inline-block;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 0.875rem;
      text-align: center;
    }
    
    .btn-primary {
      background: var(--color-navy-950);
      color: white;
    }
    
    .btn-primary:hover {
      background: #041640;
    }
    
    .btn-secondary {
      background: white;
      color: var(--color-navy-950);
      border: 1px solid var(--color-navy-300);
    }
    
    .btn-secondary:hover {
      background: var(--color-navy-50);
    }
    
    .btn-accent {
      background: var(--color-orange-500);
      color: white;
    }
    
    .btn-accent:hover {
      background: #e36a00;
    }
    
    .btn-block {
      display: block;
      width: 100%;
    }
    
    .btn-group {
      display: flex;
      gap: 0.5rem;
    }

    /* Shape Toggle Styles */
    .shape-toggle {
      display: flex;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .shape-option {
      flex: 1;
      padding: 0.5rem;
      text-align: center;
      background: white;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border-right: 1px solid var(--color-navy-200);
    }

    .shape-option:last-child {
      border-right: none;
    }

    .shape-option:hover {
      background: var(--color-navy-50);
    }

    .shape-option.selected {
      background: var(--color-navy-950);
      color: white;
    }

    .shape-controls {
      transition: all 0.3s ease;
    }

    /* Triangle Panel Styles */
    .panel-item.triangle {
      background: linear-gradient(135deg, var(--color-navy-100) 0%, var(--color-navy-200) 100%);
      border: 2px solid var(--color-navy-500);
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .panel-item.triangle .panel-label {
      color: var(--color-navy-900);
      font-weight: 600;
      text-align: center;
      line-height: 1.2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      transform: translateY(-10%);
    }

    /* Hexagon Panel Styles */
    .panel-item.hexagon {
      background: linear-gradient(135deg, var(--color-orange-100) 0%, var(--color-orange-200) 100%);
      border: 2px solid var(--color-orange-500);
      clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .panel-item.hexagon .panel-label {
      color: var(--color-orange-900);
      font-weight: 600;
      text-align: center;
      line-height: 1.2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    
    .panel-canvas-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .canvas-toolbar {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--color-navy-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .toolbar-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-navy-800);
    }
    
    .panel-canvas {
      flex-grow: 1;
      background-color: #f8fafc;
      border: 1px dashed var(--color-navy-300);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    
    .panel-canvas.grid-background {
      background-image: linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(0,0,0,0.05) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    .panel {
      position: absolute;
      background-color: rgba(10, 36, 99, 0.15);
      border: 2px solid var(--color-navy-950);
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-navy-800);
      user-select: none;
    }
    
    .panel.selected {
      background-color: rgba(255, 127, 17, 0.15);
      border-color: var(--color-orange-500);
      z-index: 10;
    }
    
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: white;
      border: 1px solid var(--color-navy-950);
      z-index: 20;
    }
    
    .resize-handle-nw { top: -5px; left: -5px; cursor: nwse-resize; }
    .resize-handle-ne { top: -5px; right: -5px; cursor: nesw-resize; }
    .resize-handle-se { bottom: -5px; right: -5px; cursor: nwse-resize; }
    .resize-handle-sw { bottom: -5px; left: -5px; cursor: nesw-resize; }
    
    .rotate-handle {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 20px;
      background-color: white;
      border: 2px solid var(--color-orange-500);
      border-radius: 50%;
      cursor: alias;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .panel-properties {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      width: 250px;
      z-index: 30;
      border: 1px solid var(--color-navy-200);
    }
    
    .property-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: var(--color-navy-800);
    }
    
    .property-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .property-label {
      font-size: 0.75rem;
      color: var(--color-navy-600);
    }
    
    .property-value {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-navy-800);
    }
    
    .workspace-scale {
      position: absolute;
      bottom: 1rem;
      left: 1rem;
      background: white;
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border: 1px solid var(--color-navy-200);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: var(--color-navy-700);
    }
    
    .zoom-controls {
      display: flex;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .zoom-btn {
      background: white;
      border: none;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    
    .zoom-btn:hover {
      background: var(--color-navy-50);
    }
    
    .zoom-value {
      padding: 0.25rem 0.5rem;
      background: var(--color-navy-50);
      display: inline-block;
      min-width: 40px;
      text-align: center;
    }
    
    .material-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .material-type {
      display: inline-block;
      padding: 0.35rem 0.65rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      background: var(--color-navy-100);
      color: var(--color-navy-800);
    }
    
    .panel-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    
    .panel-list-item {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--color-navy-100);
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }
    
    .panel-list-item:last-child {
      border-bottom: none;
    }
    
    .panel-list-item:hover {
      background: var(--color-navy-50);
    }
    
    .panel-list-item.selected {
      background: var(--color-navy-100);
      font-weight: 500;
    }
    
    .sidebar-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid var(--color-navy-100);
    }
    
    /* File export & import */
    .export-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    /* Optimization controls */
    .optimization-toggle {
      display: flex;
      border: 1px solid var(--color-navy-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .optimization-option {
      flex: 1;
      padding: 0.5rem;
      text-align: center;
      background: white;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .optimization-option.selected {
      background: var(--color-navy-950);
      color: white;
    }
    
    /* Switch toggle */
    .switch-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .switch-label {
      font-size: 0.875rem;
      color: var(--color-navy-700);
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-navy-200);
      transition: .3s;
      border-radius: 20px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--color-orange-500);
    }
    
    input:checked + .slider:before {
      transform: translateX(16px);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">GeoQC</div>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/dashboard/projects">Projects</a>
      <a href="/dashboard/panel-layout" class="active">Panel Layout</a>
      <a href="/dashboard/qc-data">QC Data</a>
      <a href="/dashboard/documents">Documents</a>
    </nav>
  </header>
  
  <div class="container">
    <div class="panel-layout-interface">
      <div class="panel-controls">
        <div class="control-section">
          <h2 class="section-title">Project Details</h2>
          <div class="form-group">
            <label for="project-name">Project</label>
            <select id="project-name">
              <option>Landfill Cell 4 Expansion</option>
              <option>Industrial Retention Pond</option>
              <option>Wastewater Treatment Lining</option>
            </select>
          </div>
        </div>
        
        <div class="control-section">
          <h2 class="section-title">Workspace Setup</h2>
          <div class="form-group">
            <label>Workspace Dimensions</label>
            <div class="dimensions-grid">
              <div>
                <label for="workspace-width">Width (ft)</label>
                <input type="number" id="workspace-width" value="100" min="10" max="1000">
              </div>
              <div>
                <label for="workspace-height">Length (ft)</label>
                <input type="number" id="workspace-height" value="150" min="10" max="1000">
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="switch-container">
              <span class="switch-label">Show Grid</span>
              <label class="switch">
                <input type="checkbox" id="show-grid" checked>
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <button id="reset-workspace" class="btn btn-secondary btn-block">Reset Workspace</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2 class="section-title">Panel Creation</h2>
          <div class="form-group">
            <label>Panel Shape</label>
            <div class="shape-toggle">
              <div class="shape-option selected" data-shape="rectangle">Rectangle</div>
              <div class="shape-option" data-shape="triangle">Triangle</div>
              <div class="shape-option" data-shape="hexagon">Hexagon</div>
            </div>
          </div>
          
          <div id="rectangle-controls" class="shape-controls">
            <div class="form-group">
              <label>Standard Panel Dimensions</label>
              <div class="dimensions-grid">
                <div>
                  <label for="panel-width">Width (ft)</label>
                  <input type="number" id="panel-width" value="15" min="1" max="100">
                </div>
                <div>
                  <label for="panel-length">Length (ft)</label>
                  <input type="number" id="panel-length" value="100" min="1" max="500">
                </div>
              </div>
            </div>
          </div>
          
          <div id="triangle-controls" class="shape-controls" style="display: none;">
            <div class="form-group">
              <label>Triangle Panel Dimensions</label>
              <div class="dimensions-grid">
                <div>
                  <label for="triangle-base">Base (ft)</label>
                  <input type="number" id="triangle-base" value="15" min="1" max="100">
                </div>
                <div>
                  <label for="triangle-height">Height (ft)</label>
                  <input type="number" id="triangle-height" value="12" min="1" max="100">
                </div>
              </div>
            </div>
          </div>

          <div id="hexagon-controls" class="shape-controls" style="display: none;">
            <div class="form-group">
              <label>Hexagon Panel Dimensions</label>
              <div class="dimensions-grid">
                <div>
                  <label for="hexagon-width">Width (ft)</label>
                  <input type="number" id="hexagon-width" value="20" min="1" max="100">
                </div>
                <div>
                  <label for="hexagon-height">Height (ft)</label>
                  <input type="number" id="hexagon-height" value="17" min="1" max="100">
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="panel-material">Material Type</label>
            <select id="panel-material">
              <option>HDPE 60 mil</option>
              <option>HDPE 80 mil</option>
              <option>LLDPE 40 mil</option>
              <option>PVC 30 mil</option>
              <option>GCL</option>
            </select>
          </div>
          <div class="form-group">
            <button id="add-panel" class="btn btn-primary btn-block">Add Panel</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2 class="section-title">Panel Management</h2>
          <div class="panel-list" id="panel-list">
            <!-- Panels will be listed here dynamically -->
            <div class="panel-list-item" data-panel-id="panel-1">Panel 1 <span>15' x 100'</span></div>
            <div class="panel-list-item" data-panel-id="panel-2">Panel 2 <span>15' x 100'</span></div>
            <div class="panel-list-item selected" data-panel-id="panel-3">Panel 3 <span>15' x 100'</span></div>
          </div>
          <div class="btn-group">
            <button id="duplicate-panel" class="btn btn-secondary">Duplicate</button>
            <button id="delete-panel" class="btn btn-secondary">Delete</button>
          </div>
        </div>
        
        <div class="control-section">
          <h2 class="section-title">AI Optimization</h2>
          <div class="optimization-toggle">
            <div class="optimization-option" data-option="material">Material</div>
            <div class="optimization-option" data-option="labor">Labor</div>
            <div class="optimization-option selected" data-option="balanced">Balanced</div>
          </div>
          <div class="form-group">
            <button id="ai-optimize" class="btn btn-accent btn-block">AI Optimize Layout</button>
          </div>
        </div>
        
        <div class="sidebar-footer">
          <div class="export-section">
            <div class="btn-group">
              <button id="export-dxf" class="btn btn-secondary">Export DXF</button>
              <button id="export-excel" class="btn btn-secondary">Export Excel</button>
            </div>
            <button id="save-layout" class="btn btn-primary btn-block">Save Layout</button>
          </div>
        </div>
      </div>
      
      <div class="panel-canvas-container">
        <div class="canvas-toolbar">
          <h2 class="toolbar-title">Panel Layout: Landfill Cell 4 Expansion</h2>
          <div class="zoom-controls">
            <button class="zoom-btn" id="zoom-out">−</button>
            <span class="zoom-value" id="zoom-level">100%</span>
            <button class="zoom-btn" id="zoom-in">+</button>
          </div>
        </div>
        
        <div class="panel-canvas grid-background" id="panel-canvas">
          <!-- Panels will be added here -->
          <div class="panel" style="width: 150px; height: 400px; left: 100px; top: 100px;" data-panel-id="panel-1">
            Panel 1
          </div>
          <div class="panel" style="width: 150px; height: 400px; left: 300px; top: 100px;" data-panel-id="panel-2">
            Panel 2
          </div>
          <div class="panel selected" style="width: 150px; height: 400px; left: 500px; top: 100px;" data-panel-id="panel-3">
            Panel 3
            <div class="resize-handle resize-handle-nw"></div>
            <div class="resize-handle resize-handle-ne"></div>
            <div class="resize-handle resize-handle-se"></div>
            <div class="resize-handle resize-handle-sw"></div>
            <div class="rotate-handle">↻</div>
          </div>
          
          <!-- Panel properties popup (shows when a panel is selected) -->
          <div class="panel-properties">
            <h3 class="property-title">Panel 3 Properties</h3>
            <div class="property-grid">
              <div class="property-label">Width:</div>
              <div class="property-value">15 ft</div>
              <div class="property-label">Length:</div>
              <div class="property-value">100 ft</div>
              <div class="property-label">Area:</div>
              <div class="property-value">1,500 ft²</div>
              <div class="property-label">Position:</div>
              <div class="property-value">X: 50', Y: 10'</div>
              <div class="property-label">Rotation:</div>
              <div class="property-value">0°</div>
            </div>
            <div class="material-info">
              <span class="material-type">HDPE 60 mil</span>
            </div>
          </div>
          
          <!-- Scale indicator -->
          <div class="workspace-scale">
            <span>Scale: 1" = 20'</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/panel-optimizer.js"></script>
  <script>
    // Panel Layout Tool JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      // Elements
      const panelCanvas = document.getElementById('panel-canvas');
      const addPanelBtn = document.getElementById('add-panel');
      const panelList = document.getElementById('panel-list');
      const showGridCheckbox = document.getElementById('show-grid');
      const resetWorkspaceBtn = document.getElementById('reset-workspace');
      const zoomInBtn = document.getElementById('zoom-in');
      const zoomOutBtn = document.getElementById('zoom-out');
      const zoomLevelEl = document.getElementById('zoom-level');
      const workspaceWidthInput = document.getElementById('workspace-width');
      const workspaceHeightInput = document.getElementById('workspace-height');
      const panelWidthInput = document.getElementById('panel-width');
      const panelLengthInput = document.getElementById('panel-length');
      const panelMaterialSelect = document.getElementById('panel-material');
      const aiOptimizeBtn = document.getElementById('ai-optimize');
      const optimizationOptions = document.querySelectorAll('.optimization-option');
      const duplicatePanelBtn = document.getElementById('duplicate-panel');
      const deletePanelBtn = document.getElementById('delete-panel');
      const exportDxfBtn = document.getElementById('export-dxf');
      const exportExcelBtn = document.getElementById('export-excel');
      const saveLayoutBtn = document.getElementById('save-layout');

      // Shape selection variables
      let selectedShape = 'rectangle';

      // Shape selection handling
      document.querySelectorAll('.shape-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.shape-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          selectedShape = this.dataset.shape;
          
          // Show/hide appropriate controls
          document.querySelectorAll('.shape-controls').forEach(control => {
            control.style.display = 'none';
          });
          
          if (selectedShape === 'rectangle') {
            document.getElementById('rectangle-controls').style.display = 'block';
          } else if (selectedShape === 'triangle') {
            document.getElementById('triangle-controls').style.display = 'block';
          } else if (selectedShape === 'hexagon') {
            document.getElementById('hexagon-controls').style.display = 'block';
          }
        });
      });
      
      // Variables
      let panelCounter = 4; // Start at 4 since we have 3 initial panels
      let selectedPanelId = 'panel-3';
      let currentZoom = 100;
      let isDragging = false;
      let dragStartX;
      let dragStartY;
      let draggedElement;
      let dragOffsetX;
      let dragOffsetY;
      let isResizing = false;
      let resizeHandle = null;
      let isRotating = false;
      let panelDefs = []; // Panel definitions for optimizer
      let elevationGrid = []; // Elevation data
      
      // Initialize panel definitions with starting panels
      function initializePanelDefs() {
        panelDefs = [];
        
        // Get all panels from the canvas
        document.querySelectorAll('.panel').forEach(panel => {
          const id = panel.dataset.panelId;
          const width = parseInt(panel.style.width, 10) / 10; // Convert from pixels to feet
          const height = parseInt(panel.style.height, 10) / 4; // Convert from pixels to feet
          const material = panel.dataset.material || 'HDPE 60 mil';
          
          panelDefs.push({
            id: id,
            width: width,
            length: height, // Using height as length
            material: material
          });
        });
        
        return panelDefs;
      }
      
      // Create sample elevation grid (5x5 grid for 25 acre site)
      function createSampleElevationGrid() {
        const gridSize = 5; // 5x5 grid
        const cellWidth = parseInt(workspaceWidthInput.value, 10) / gridSize;
        const cellHeight = parseInt(workspaceHeightInput.value, 10) / gridSize;
        
        elevationGrid = [];
        
        // Create a 5x5 grid with varying elevations
        for (let row = 0; row < gridSize; row++) {
          for (let col = 0; col < gridSize; col++) {
            // Create some sample elevation changes
            // Southwest corner is lowest, northeast is highest
            const baseElevation = (row + col) * 2; // 0 to 16 ft elevation change
            
            // Add some random variation
            const variation = Math.random() * 1.5 - 0.75; // -0.75 to +0.75 ft
            
            elevationGrid.push({
              x: col * cellWidth,
              y: row * cellHeight,
              width: cellWidth,
              height: cellHeight,
              elevation: baseElevation + variation
            });
          }
        }
        
        return elevationGrid;
      }
      
      // Event Listeners
      
      // Toggle grid
      showGridCheckbox.addEventListener('change', function() {
        panelCanvas.classList.toggle('grid-background', this.checked);
      });
      
      // Reset workspace
      resetWorkspaceBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to reset the workspace? All panels will be removed.')) {
          // Remove all panels except the properties popup and scale indicator
          document.querySelectorAll('.panel').forEach(panel => panel.remove());
          
          // Clear panel list
          while (panelList.firstChild) {
            panelList.removeChild(panelList.firstChild);
          }
          
          panelCounter = 1;
          selectedPanelId = null;
          
          // Reset workspace dimensions
          workspaceWidthInput.value = 100;
          workspaceHeightInput.value = 150;
          
          // Hide panel properties
          document.querySelector('.panel-properties').style.display = 'none';
        }
      });
      
      // Add new panel
      addPanelBtn.addEventListener('click', function() {
        const panelWidth = parseInt(panelWidthInput.value, 10);
        const panelLength = parseInt(panelLengthInput.value, 10);
        const materialType = panelMaterialSelect.value;
        
        // Create panel element
        const panel = document.createElement('div');
        panel.className = 'panel';
        panel.dataset.panelId = `panel-${panelCounter}`;
        panel.style.width = `${panelWidth * 10}px`; // Scale properly
        panel.style.height = `${panelLength * 4}px`; // Scale properly
        panel.style.left = '50px';
        panel.style.top = '50px';
        panel.textContent = `Panel ${panelCounter}`;
        panel.dataset.material = materialType;
        panel.dataset.elevationAdjustment = '0'; // Default elevation adjustment
        
        // Add panel to canvas
        panelCanvas.appendChild(panel);
        
        // Add panel to list
        const listItem = document.createElement('div');
        listItem.className = 'panel-list-item';
        listItem.dataset.panelId = `panel-${panelCounter}`;
        listItem.innerHTML = `Panel ${panelCounter} <span>${panelWidth}' x ${panelLength}'</span>`;
        panelList.appendChild(listItem);
        
        // Attach click event to list item
        listItem.addEventListener('click', function() {
          selectPanel(this.dataset.panelId);
        });
        
        // Select the new panel
        selectPanel(`panel-${panelCounter}`);
        
        panelCounter++;
      });
      
      // Panel selection in the list
      document.querySelectorAll('.panel-list-item').forEach(item => {
        item.addEventListener('click', function() {
          selectPanel(this.dataset.panelId);
        });
      });
      
      // Make panels draggable, resizable and rotatable
      panelCanvas.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('panel')) {
          // Panel dragging
          isDragging = true;
          isResizing = false;
          isRotating = false;
          draggedElement = e.target;
          
          // Select the panel
          selectPanel(draggedElement.dataset.panelId);
          
          // Calculate the offset
          const rect = draggedElement.getBoundingClientRect();
          dragOffsetX = e.clientX - rect.left;
          dragOffsetY = e.clientY - rect.top;
          
          dragStartX = e.clientX;
          dragStartY = e.clientY;
        } else if (e.target.classList.contains('resize-handle')) {
          // Panel resizing
          isDragging = false;
          isResizing = true;
          isRotating = false;
          resizeHandle = e.target;
          draggedElement = resizeHandle.parentElement;
          
          // Select the panel
          selectPanel(draggedElement.dataset.panelId);
          
          dragStartX = e.clientX;
          dragStartY = e.clientY;
        } else if (e.target.classList.contains('rotate-handle')) {
          // Panel rotation
          isDragging = false;
          isResizing = false;
          isRotating = true;
          draggedElement = e.target.parentElement;
          
          // Select the panel
          selectPanel(draggedElement.dataset.panelId);
          
          // Get the panel center for rotation
          const rect = draggedElement.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          // Calculate the initial angle
          const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
          draggedElement.dataset.lastAngle = angle;
        }
      });
      
      document.addEventListener('mousemove', function(e) {
        if (isDragging) {
          // Move the panel
          const newLeft = e.clientX - dragOffsetX;
          const newTop = e.clientY - dragOffsetY;
          
          draggedElement.style.left = `${newLeft}px`;
          draggedElement.style.top = `${newTop}px`;
          
          // Update panel properties if showing
          updatePanelProperties();
        } else if (isResizing && resizeHandle) {
          // Resize the panel
          const rect = draggedElement.getBoundingClientRect();
          const currentWidth = rect.width;
          const currentHeight = rect.height;
          
          let newWidth = currentWidth;
          let newHeight = currentHeight;
          
          // Determine resize direction based on handle class
          if (resizeHandle.classList.contains('resize-handle-se')) {
            // Southeast - resize width and height
            newWidth = currentWidth + (e.clientX - dragStartX);
            newHeight = currentHeight + (e.clientY - dragStartY);
          } else if (resizeHandle.classList.contains('resize-handle-sw')) {
            // Southwest - resize width and height, adjust left
            newWidth = currentWidth - (e.clientX - dragStartX);
            newHeight = currentHeight + (e.clientY - dragStartY);
            draggedElement.style.left = `${parseInt(draggedElement.style.left, 10) + (e.clientX - dragStartX)}px`;
          } else if (resizeHandle.classList.contains('resize-handle-ne')) {
            // Northeast - resize width and height, adjust top
            newWidth = currentWidth + (e.clientX - dragStartX);
            newHeight = currentHeight - (e.clientY - dragStartY);
            draggedElement.style.top = `${parseInt(draggedElement.style.top, 10) + (e.clientY - dragStartY)}px`;
          } else if (resizeHandle.classList.contains('resize-handle-nw')) {
            // Northwest - resize width and height, adjust left and top
            newWidth = currentWidth - (e.clientX - dragStartX);
            newHeight = currentHeight - (e.clientY - dragStartY);
            draggedElement.style.left = `${parseInt(draggedElement.style.left, 10) + (e.clientX - dragStartX)}px`;
            draggedElement.style.top = `${parseInt(draggedElement.style.top, 10) + (e.clientY - dragStartY)}px`;
          }
          
          // Ensure minimum size
          newWidth = Math.max(50, newWidth);
          newHeight = Math.max(50, newHeight);
          
          // Update panel size
          draggedElement.style.width = `${newWidth}px`;
          draggedElement.style.height = `${newHeight}px`;
          
          // Update drag start for next move
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          
          // Update panel properties if showing
          updatePanelProperties();
          
          // Update panel list item with new dimensions
          updatePanelListItem(draggedElement.dataset.panelId, newWidth, newHeight);
        } else if (isRotating) {
          // Get the panel center for rotation
          const rect = draggedElement.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          // Calculate the current angle
          const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
          
          // Calculate rotation change in radians
          const lastAngle = parseFloat(draggedElement.dataset.lastAngle) || 0;
          const deltaAngle = angle - lastAngle;
          
          // Get current rotation
          const currentTransform = draggedElement.style.transform || '';
          let currentRotation = 0;
          
          if (currentTransform.includes('rotate')) {
            currentRotation = parseFloat(currentTransform.split('rotate(')[1].split('deg)')[0]) || 0;
          }
          
          // Calculate new rotation (convert from radians to degrees)
          const newRotation = currentRotation + deltaAngle * (180 / Math.PI);
          
          // Apply rotation (snap to nearest 45 degrees when close)
          const snappedRotation = Math.round(newRotation / 45) * 45;
          draggedElement.style.transform = `rotate(${snappedRotation}deg)`;
          
          // Save the current angle for next calculation
          draggedElement.dataset.lastAngle = angle;
          
          // Update panel properties if showing
          updatePanelProperties();
        }
      });
      
      document.addEventListener('mouseup', function() {
        isDragging = false;
        isResizing = false;
        isRotating = false;
        draggedElement = null;
        resizeHandle = null;
      });
      
      // Panel duplication
      duplicatePanelBtn.addEventListener('click', function() {
        if (!selectedPanelId) return;
        
        const panel = document.querySelector(`.panel[data-panel-id="${selectedPanelId}"]`);
        if (!panel) return;
        
        // Copy panel properties
        const width = parseInt(panel.style.width, 10);
        const height = parseInt(panel.style.height, 10);
        const left = parseInt(panel.style.left, 10) + 20; // Offset for visibility
        const top = parseInt(panel.style.top, 10) + 20; // Offset for visibility
        const material = panel.dataset.material;
        const transform = panel.style.transform;
        
        // Create new panel
        const newPanel = document.createElement('div');
        newPanel.className = 'panel';
        newPanel.dataset.panelId = `panel-${panelCounter}`;
        newPanel.style.width = `${width}px`;
        newPanel.style.height = `${height}px`;
        newPanel.style.left = `${left}px`;
        newPanel.style.top = `${top}px`;
        newPanel.style.transform = transform;
        newPanel.textContent = `Panel ${panelCounter}`;
        newPanel.dataset.material = material;
        newPanel.dataset.elevationAdjustment = panel.dataset.elevationAdjustment || '0';
        
        // Add panel to canvas
        panelCanvas.appendChild(newPanel);
        
        // Add to panel list
        const listItem = document.createElement('div');
        listItem.className = 'panel-list-item';
        listItem.dataset.panelId = `panel-${panelCounter}`;
        listItem.innerHTML = `Panel ${panelCounter} <span>${Math.round(width/10)}' x ${Math.round(height/4)}'</span>`;
        panelList.appendChild(listItem);
        
        // Attach click event to list item
        listItem.addEventListener('click', function() {
          selectPanel(this.dataset.panelId);
        });
        
        // Select the new panel
        selectPanel(`panel-${panelCounter}`);
        
        panelCounter++;
      });
      
      // Panel deletion
      deletePanelBtn.addEventListener('click', function() {
        if (!selectedPanelId) return;
        
        // Remove panel from canvas
        const panel = document.querySelector(`.panel[data-panel-id="${selectedPanelId}"]`);
        if (panel) {
          panel.remove();
        }
        
        // Remove from panel list
        const listItem = document.querySelector(`.panel-list-item[data-panel-id="${selectedPanelId}"]`);
        if (listItem) {
          listItem.remove();
        }
        
        // Hide panel properties
        document.querySelector('.panel-properties').style.display = 'none';
        
        selectedPanelId = null;
      });
      
      // Optimization option selection
      optimizationOptions.forEach(option => {
        option.addEventListener('click', function() {
          // Remove selected class from all options
          optimizationOptions.forEach(opt => opt.classList.remove('selected'));
          
          // Add selected class to clicked option
          this.classList.add('selected');
        });
      });
      
      // AI optimize button with advanced features
      aiOptimizeBtn.addEventListener('click', function() {
        const selectedOption = document.querySelector('.optimization-option.selected').dataset.option;
        
        // Show processing message
        const optimizeMessage = document.createElement('div');
        optimizeMessage.style.position = 'absolute';
        optimizeMessage.style.top = '50%';
        optimizeMessage.style.left = '50%';
        optimizeMessage.style.transform = 'translate(-50%, -50%)';
        optimizeMessage.style.padding = '15px 25px';
        optimizeMessage.style.background = 'rgba(255, 255, 255, 0.9)';
        optimizeMessage.style.borderRadius = '8px';
        optimizeMessage.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
        optimizeMessage.style.zIndex = '100';
        optimizeMessage.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 10px;">Optimizing Panel Layout</div>
          <div>Applying ${selectedOption} optimization strategy...</div>
          <div style="font-size: 0.875rem; margin-top: 10px; color: #627d98;">
            Processing site topography and constraints
          </div>
        `;
        document.body.appendChild(optimizeMessage);
        
        // Initialize panel definitions
        const panels = initializePanelDefs();
        
        // Create sample elevation grid
        const elevations = createSampleElevationGrid();
        
        // Create the site configuration
        const siteConfig = {
          width: parseInt(workspaceWidthInput.value, 10),
          length: parseInt(workspaceHeightInput.value, 10),
          noGoZones: [], // Could be added in a more advanced implementation
          elevationGrid: elevations
        };
        
        // Create the optimizer
        const optimizer = new PanelOptimizer(siteConfig, panels, selectedOption);
        
        // Use setTimeout to allow the UI to update
        setTimeout(() => {
          // Run the optimization
          const result = optimizer.optimize();
          
          // Remove all current panels
          document.querySelectorAll('.panel').forEach(panel => panel.remove());
          
          // Clear the panel list
          while (panelList.firstChild) {
            panelList.removeChild(panelList.firstChild);
          }
          
          // Reset counter and add new panels based on the optimized layout
          panelCounter = 1;
          
          // Add the optimized panels
          result.placements.forEach(placement => {
            const panel = panels.find(p => p.id === placement.id);
            if (!panel) return;
            
            // Calculate dimensions based on rotation
            const isRotated = placement.rotation === 90;
            const width = isRotated ? panel.length : panel.width;
            const height = isRotated ? panel.width : panel.length;
            
            // Create panel element
            const panelElement = document.createElement('div');
            panelElement.className = 'panel';
            panelElement.dataset.panelId = `panel-${panelCounter}`;
            panelElement.style.width = `${width * 10}px`; // Scale properly
            panelElement.style.height = `${height * 4}px`; // Scale properly
            panelElement.style.left = `${placement.x}px`;
            panelElement.style.top = `${placement.y}px`;
            panelElement.style.transform = `rotate(${placement.rotation}deg)`;
            panelElement.textContent = `Panel ${panelCounter}`;
            panelElement.dataset.material = panel.material;
            panelElement.dataset.elevationAdjustment = placement.elevationAdjustment.toString();
            
            // Add panel to canvas
            panelCanvas.appendChild(panelElement);
            
            // Add to panel list
            const listItem = document.createElement('div');
            listItem.className = 'panel-list-item';
            listItem.dataset.panelId = `panel-${panelCounter}`;
            listItem.innerHTML = `Panel ${panelCounter} <span>${width}' x ${height}'</span>`;
            panelList.appendChild(listItem);
            
            // Attach click event to list item
            listItem.addEventListener('click', function() {
              selectPanel(this.dataset.panelId);
            });
            
            panelCounter++;
          });
          
          // Select the first panel if there is one
          if (document.querySelector('.panel')) {
            selectPanel(document.querySelector('.panel').dataset.panelId);
          }
          
          // Remove the processing message
          document.body.removeChild(optimizeMessage);
          
          // Show optimization summary
          showOptimizationSummary(result.summary);
        }, 1500);
      });
      
      // Show optimization summary
      function showOptimizationSummary(summary) {
        const summaryPopup = document.createElement('div');
        summaryPopup.style.position = 'fixed';
        summaryPopup.style.top = '50%';
        summaryPopup.style.left = '50%';
        summaryPopup.style.transform = 'translate(-50%, -50%)';
        summaryPopup.style.background = 'white';
        summaryPopup.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.15)';
        summaryPopup.style.borderRadius = '8px';
        summaryPopup.style.padding = '24px';
        summaryPopup.style.zIndex = '1000';
        summaryPopup.style.maxWidth = '500px';
        summaryPopup.style.width = '90%';
        
        summaryPopup.innerHTML = `
          <div style="font-size: 1.25rem; font-weight: 600; color: var(--color-navy-950); margin-bottom: 16px;">
            Optimization Results: ${summary.strategy.charAt(0).toUpperCase() + summary.strategy.slice(1)} Strategy
          </div>
          <div style="margin-bottom: 16px">
            <div style="font-weight: 500; margin-bottom: 8px">Layout Statistics</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <div>Total Panels:</div>
              <div>${summary.totalPanels}</div>
              <div>Site Utilization:</div>
              <div>${summary.siteUtilization}</div>
              <div>Panels with Elevation Adjustments:</div>
              <div>${summary.elevatedPanels}</div>
              <div>Average Elevation Adjustment:</div>
              <div>${summary.averageElevationAdjustment} ft</div>
            </div>
          </div>
          <div style="margin-bottom: 20px">
            <div style="font-weight: 500; margin-bottom: 8px">Slope Impact Analysis</div>
            <div style="padding: 12px; background: var(--color-navy-50); border-radius: 4px; font-size: 0.875rem;">
              ${summary.slopeImpact}
            </div>
          </div>
          <div style="text-align: right">
            <button id="close-summary" style="padding: 8px 16px; background: var(--color-navy-950); color: white; border: none; border-radius: 4px; cursor: pointer;">
              Close
            </button>
          </div>
        `;
        
        document.body.appendChild(summaryPopup);
        
        // Close button event
        document.getElementById('close-summary').addEventListener('click', function() {
          document.body.removeChild(summaryPopup);
        });
      }
      
      // Zoom controls
      zoomInBtn.addEventListener('click', function() {
        if (currentZoom < 200) {
          currentZoom += 10;
          updateZoom();
        }
      });
      
      zoomOutBtn.addEventListener('click', function() {
        if (currentZoom > 50) {
          currentZoom -= 10;
          updateZoom();
        }
      });
      
      // Export buttons with enhanced functionality
      exportDxfBtn.addEventListener('click', function() {
        // Get all panels
        const panels = initializePanelDefs();
        
        // Get panel placements
        const placements = [];
        document.querySelectorAll('.panel').forEach(panel => {
          const id = panel.dataset.panelId;
          const x = parseInt(panel.style.left, 10) / 10; // Convert from pixels to feet
          const y = parseInt(panel.style.top, 10) / 10; // Convert from pixels to feet
          
          // Get rotation
          const transform = panel.style.transform;
          let rotation = 0;
          if (transform && transform.includes('rotate')) {
            rotation = parseInt(transform.split('rotate(')[1].split('deg)')[0]);
          }
          
          // Get elevation adjustment
          const elevationAdjustment = parseFloat(panel.dataset.elevationAdjustment || '0');
          
          placements.push({
            id: id,
            x: x,
            y: y,
            rotation: rotation,
            elevationAdjustment: elevationAdjustment
          });
        });
        
        // Generate JSON output
        const jsonOutput = JSON.stringify(placements, null, 2);
        
        // Create a downloadable file
        const blob = new Blob([jsonOutput], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Create a download link
        const a = document.createElement('a');
        a.href = url;
        a.download = 'panel-layout.json';
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('Panel layout exported to JSON/DXF format.');
      });
      
      exportExcelBtn.addEventListener('click', function() {
        // Get all panels
        const panels = initializePanelDefs();
        
        // Get panel placements
        const placements = [];
        document.querySelectorAll('.panel').forEach(panel => {
          const id = panel.dataset.panelId;
          const x = parseInt(panel.style.left, 10) / 10; // Convert from pixels to feet
          const y = parseInt(panel.style.top, 10) / 10; // Convert from pixels to feet
          
          // Get rotation
          const transform = panel.style.transform;
          let rotation = 0;
          if (transform && transform.includes('rotate')) {
            rotation = parseInt(transform.split('rotate(')[1].split('deg)')[0]);
          }
          
          // Get elevation adjustment
          const elevationAdjustment = parseFloat(panel.dataset.elevationAdjustment || '0');
          
          // Find the panel definition
          const panelDef = panels.find(p => p.id === id);
          if (panelDef) {
            placements.push({
              id: id,
              x: x,
              y: y,
              rotation: rotation,
              elevationAdjustment: elevationAdjustment,
              width: panelDef.width,
              length: panelDef.length,
              material: panelDef.material
            });
          }
        });
        
        // Generate CSV data
        let csvContent = "ID,X,Y,Rotation,Elevation Adjustment,Width,Length,Material\n";
        placements.forEach(p => {
          csvContent += `${p.id},${p.x},${p.y},${p.rotation},${p.elevationAdjustment},${p.width},${p.length},${p.material}\n`;
        });
        
        // Create a downloadable file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        // Create a download link
        const a = document.createElement('a');
        a.href = url;
        a.download = 'panel-layout.csv';
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('Panel layout exported to Excel/CSV format.');
      });
      
      saveLayoutBtn.addEventListener('click', function() {
        // Get all panel data
        const layoutData = {
          project: document.querySelector('#project-name').value,
          workspaceWidth: parseInt(workspaceWidthInput.value, 10),
          workspaceHeight: parseInt(workspaceHeightInput.value, 10),
          panels: []
        };
        
        // Collect panel data
        document.querySelectorAll('.panel').forEach(panel => {
          const id = panel.dataset.panelId;
          const x = parseInt(panel.style.left, 10);
          const y = parseInt(panel.style.top, 10);
          const width = parseInt(panel.style.width, 10);
          const height = parseInt(panel.style.height, 10);
          const material = panel.dataset.material;
          
          // Get rotation
          const transform = panel.style.transform;
          let rotation = 0;
          if (transform && transform.includes('rotate')) {
            rotation = parseInt(transform.split('rotate(')[1].split('deg)')[0]);
          }
          
          // Get elevation adjustment
          const elevationAdjustment = parseFloat(panel.dataset.elevationAdjustment || '0');
          
          layoutData.panels.push({
            id: id,
            x: x,
            y: y,
            width: width,
            height: height,
            rotation: rotation,
            material: material,
            elevationAdjustment: elevationAdjustment
          });
        });
        
        // Convert to JSON string
        const layoutJSON = JSON.stringify(layoutData);
        
        // In a real application, this would save to server
        // For now, we'll just save to localStorage
        localStorage.setItem('geoqc-panel-layout', layoutJSON);
        
        alert('Layout saved successfully!');
      });
      
      // Helper Functions
      
      // Update panel list item with new dimensions
      function updatePanelListItem(panelId, width, height) {
        const listItem = document.querySelector(`.panel-list-item[data-panel-id="${panelId}"]`);
        if (listItem) {
          const widthFt = Math.round(width / 10);
          const heightFt = Math.round(height / 4);
          listItem.innerHTML = `${listItem.textContent.split('<')[0]} <span>${widthFt}' x ${heightFt}'</span>`;
        }
      }
      
      // Select a panel
      function selectPanel(panelId) {
        // Remove selected class from all panels and list items
        document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('selected'));
        document.querySelectorAll('.panel-list-item').forEach(item => item.classList.remove('selected'));
        
        // Remove all resize handles and rotate handles
        document.querySelectorAll('.resize-handle, .rotate-handle').forEach(handle => handle.remove());
        
        selectedPanelId = panelId;
        
        // Add selected class to the selected panel and list item
        const panel = document.querySelector(`.panel[data-panel-id="${panelId}"]`);
        const listItem = document.querySelector(`.panel-list-item[data-panel-id="${panelId}"]`);
        
        if (panel) {
          panel.classList.add('selected');
          
          // Add resize handles
          const nwHandle = document.createElement('div');
          nwHandle.className = 'resize-handle resize-handle-nw';
          panel.appendChild(nwHandle);
          
          const neHandle = document.createElement('div');
          neHandle.className = 'resize-handle resize-handle-ne';
          panel.appendChild(neHandle);
          
          const seHandle = document.createElement('div');
          seHandle.className = 'resize-handle resize-handle-se';
          panel.appendChild(seHandle);
          
          const swHandle = document.createElement('div');
          swHandle.className = 'resize-handle resize-handle-sw';
          panel.appendChild(swHandle);
          
          // Add rotate handle
          const rotateHandle = document.createElement('div');
          rotateHandle.className = 'rotate-handle';
          rotateHandle.textContent = '↻';
          panel.appendChild(rotateHandle);
          
          // Show panel properties
          updatePanelProperties();
          document.querySelector('.panel-properties').style.display = 'block';
        }
        
        if (listItem) {
          listItem.classList.add('selected');
        }
      }
      
      // Update panel properties display
      function updatePanelProperties() {
        const panel = document.querySelector(`.panel[data-panel-id="${selectedPanelId}"]`);
        if (!panel) return;
        
        const props = document.querySelector('.panel-properties');
        const rect = panel.getBoundingClientRect();
        
        // Calculate the real-world dimensions based on the current scale
        const widthFt = Math.round(rect.width / 10);
        const lengthFt = Math.round(rect.height / 4);
        const areaFt = widthFt * lengthFt;
        
        // Calculate position in feet from pixels
        const leftFt = Math.round(parseInt(panel.style.left, 10) / 10);
        const topFt = Math.round(parseInt(panel.style.top, 10) / 10);
        
        // Update the properties
        props.querySelector('.property-title').textContent = `${panel.textContent} Properties`;
        props.querySelectorAll('.property-value')[0].textContent = `${widthFt} ft`;
        props.querySelectorAll('.property-value')[1].textContent = `${lengthFt} ft`;
        props.querySelectorAll('.property-value')[2].textContent = `${areaFt.toLocaleString()} ft²`;
        props.querySelectorAll('.property-value')[3].textContent = `X: ${leftFt}', Y: ${topFt}'`;
        
        // Get rotation if any
        const transform = panel.style.transform;
        let rotation = '0°';
        if (transform && transform.includes('rotate')) {
          rotation = transform.split('rotate(')[1].split('deg)')[0] + '°';
        }
        props.querySelectorAll('.property-value')[4].textContent = rotation;
        
        // Update material type
        const materialSpan = props.querySelector('.material-type');
        materialSpan.textContent = panel.dataset.material || 'HDPE 60 mil';
        
        // Add elevation adjustment display if any
        const elevationAdjustment = parseFloat(panel.dataset.elevationAdjustment || '0');
        if (Math.abs(elevationAdjustment) > 0.1) {
          // Add or update elevation badge
          let elevationBadge = props.querySelector('.elevation-badge');
          if (!elevationBadge) {
            elevationBadge = document.createElement('span');
            elevationBadge.className = 'material-type elevation-badge';
            materialSpan.parentElement.appendChild(elevationBadge);
          }
          
          elevationBadge.textContent = `Elev: ${elevationAdjustment.toFixed(1)}ft`;
          elevationBadge.style.marginLeft = '8px';
          elevationBadge.style.background = elevationAdjustment > 0 ? '#e3fcef' : '#fff7e6';
          elevationBadge.style.color = elevationAdjustment > 0 ? '#36b37e' : '#ffab00';
        } else {
          // Remove elevation badge if exists
          const elevationBadge = props.querySelector('.elevation-badge');
          if (elevationBadge) {
            elevationBadge.remove();
          }
        }
      }
      
      // Update the zoom level
      function updateZoom() {
        zoomLevelEl.textContent = `${currentZoom}%`;
        
        // Apply scale transform to the canvas content
        const scale = currentZoom / 100;
        panelCanvas.style.transform = `scale(${scale})`;
        panelCanvas.style.transformOrigin = 'top left';
      }
      
      // Load a saved layout if available
      function loadSavedLayout() {
        const savedLayout = localStorage.getItem('geoqc-panel-layout');
        if (savedLayout) {
          try {
            const layoutData = JSON.parse(savedLayout);
            
            // Set workspace dimensions
            workspaceWidthInput.value = layoutData.workspaceWidth;
            workspaceHeightInput.value = layoutData.workspaceHeight;
            
            // Set project selection if available
            if (layoutData.project) {
              const projectSelect = document.querySelector('#project-name');
              for (let i = 0; i < projectSelect.options.length; i++) {
                if (projectSelect.options[i].value === layoutData.project) {
                  projectSelect.selectedIndex = i;
                  break;
                }
              }
            }
            
            // Load panels
            if (layoutData.panels && layoutData.panels.length > 0) {
              // Clear existing panels
              document.querySelectorAll('.panel').forEach(panel => panel.remove());
              
              // Clear panel list
              while (panelList.firstChild) {
                panelList.removeChild(panelList.firstChild);
              }
              
              // Reset counter
              panelCounter = 1;
              
              // Add panels
              layoutData.panels.forEach((panelData, index) => {
                // Create panel element
                const panel = document.createElement('div');
                panel.className = 'panel';
                panel.dataset.panelId = `panel-${panelCounter}`;
                panel.style.width = `${panelData.width}px`;
                panel.style.height = `${panelData.height}px`;
                panel.style.left = `${panelData.x}px`;
                panel.style.top = `${panelData.y}px`;
                
                if (panelData.rotation) {
                  panel.style.transform = `rotate(${panelData.rotation}deg)`;
                }
                
                panel.textContent = `Panel ${panelCounter}`;
                panel.dataset.material = panelData.material;
                
                if (panelData.elevationAdjustment) {
                  panel.dataset.elevationAdjustment = panelData.elevationAdjustment.toString();
                }
                
                // Add panel to canvas
                panelCanvas.appendChild(panel);
                
                // Add to panel list
                const listItem = document.createElement('div');
                listItem.className = 'panel-list-item';
                listItem.dataset.panelId = `panel-${panelCounter}`;
                listItem.innerHTML = `Panel ${panelCounter} <span>${Math.round(panelData.width/10)}' x ${Math.round(panelData.height/4)}'</span>`;
                panelList.appendChild(listItem);
                
                // Attach click event to list item
                listItem.addEventListener('click', function() {
                  selectPanel(this.dataset.panelId);
                });
                
                panelCounter++;
              });
              
              // Select the first panel
              if (document.querySelector('.panel')) {
                selectPanel(document.querySelector('.panel').dataset.panelId);
              }
            }
          } catch (error) {
            console.error('Error loading saved layout:', error);
          }
        }
      }
      
      // Initialize
      selectPanel('panel-3');
      
      // Try to load saved layout
      // loadSavedLayout();
    });
  </script>
</body>
</html>